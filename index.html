<!DOCTYPE html>
<html lang="en">
<head>
    <!-- FIXED: Corrected charset from UTF-g to UTF-8 -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shipment Management</title>
    <link rel="icon" type="image/png" href="logo.png">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS for Excel Download -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <!-- Theme Color for PWA -->
    <meta name="theme-color" content="#4a90e2">
    <style>
        /* Custom styles */
        body { font-family: 'Inter', sans-serif; }
        /* Hide elements until fully loaded */
        .hidden { display: none; }
        /* Custom alert box */
        #alert-box {
            transition: opacity 0.3s ease-in-out;
        }
        /* Custom datalist styles */
        input[list]::-webkit-calendar-picker-indicator {
            display: none;
        }
        /* Loading Spinner */
        #loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Loading Spinner Overlay -->
    <div id="loader-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div id="loader"></div>
    </div>

    <!-- Alert Box -->
    <div id="alert-box" class="fixed top-5 right-5 p-4 rounded-lg shadow-md z-50 hidden"
         onclick="this.classList.add('hidden')">
        <span id="alert-message"></span>
    </div>

    <!-- Login Page -->
    <div id="login-page" class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Shipment Login</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-1">User Name</label>
                    <input type="text" id="username" name="username" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="password" name="password" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button type="submit"
                        class="w-full bg-blue-600 text-white py-2 px-4 rounded-md shadow-lg hover:bg-blue-700 transition duration-300 font-semibold">
                    Login
                </button>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app" class="hidden">
        <!-- Header / Navbar -->
        <header class="bg-white shadow-md sticky top-0 z-10">
            <!-- UPDATED: Removed max-w-7xl and mx-auto for 100% width -->
            <nav class="px-4 py-3 flex flex-wrap justify-between items-center">
                <div class="text-2xl font-bold text-blue-600">PFF Shipment</div>
                <div class="flex items-center space-x-2">
                    <div id="menu-items" class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                        <button data-page="add-shipment-page" class="nav-button bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Add Shipment</button>
                        <button data-page="shipment-details-page" class="nav-button bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">Shipment Details</button>
                        <button data-page="pricing-page" class="nav-button bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">Pricing</button>
                    </div>
                    <button id="logout-button" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 ml-4">Logout</button>
                </div>
            </nav>
        </header>

        <!-- Main Content Area -->
        <!-- UPDATED: Removed max-w-7xl and mx-auto for 100% width -->
        <main class="p-2 md:p-4 mt-4">

            <!-- Page: Add Shipment -->
            <div id="add-shipment-page" class="app-page">
                <!-- UPDATED: Reduced padding (p-6 to p-4) -->
                <div class="bg-white p-4 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">Add New Shipment</h2>
                    <form id="shipment-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        
                        <!-- Product Code -->
                        <div class="col-span-1 md:col-span-2 lg:col-span-3">
                            <label for="product-code" class="block text-sm font-medium text-gray-700">PRODUCTS CODE</label>
                            <input type="text" id="product-code" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <div id="product-history" class="text-sm text-gray-600 mt-1 p-2 bg-gray-50 rounded hidden"></div>
                        </div>

                        <!-- Brand Name -->
                        <div>
                            <label for="brand-name" class="block text-sm font-medium text-gray-700">BRAND NAME</label>
                            <div class="flex">
                                <input type="text" id="brand-name" list="brand-list" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-l-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <button type="button" id="add-brand-btn" class="mt-1 px-3 py-2 bg-green-500 text-white rounded-r-md hover:bg-green-600 hidden">+</button>
                            </div>
                            <datalist id="brand-list"></datalist>
                        </div>
                        
                        <!-- Vendor Name -->
                        <div>
                            <label for="vendor-name" class="block text-sm font-medium text-gray-700">VENDOR NAME</label>
                             <div class="flex">
                                <input type="text" id="vendor-name" list="vendor-list" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-l-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <button type="button" id="add-vendor-btn" class="mt-1 px-3 py-2 bg-green-500 text-white rounded-r-md hover:bg-green-600 hidden">+</button>
                            </div>
                            <datalist id="vendor-list"></datalist>
                        </div>

                        <!-- Shipment Date -->
                        <div>
                            <label for="shipment-date" class="block text-sm font-medium text-gray-700">SHIPMENT DATE</label>
                            <input type="date" id="shipment-date" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <!-- UPDATED: This span will show the formatted date -->
                            <span id="date-day" class="text-sm text-gray-500 font-medium"></span>
                        </div>

                        <!-- Quantity -->
                        <div>
                            <label for="quantity" class="block text-sm font-medium text-gray-700">QUANTITY</label>
                            <input type="number" id="quantity" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>

                        <!-- PKR -->
                        <div>
                            <label for="pkr" class="block text-sm font-medium text-gray-700">PKR</label>
                            <input type="number" id="pkr" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>

                        <!-- TOTAL PKR (Read-only) -->
                        <div>
                            <label for="total-pkr" class="block text-sm font-medium text-gray-700">TOTAL PKR</label>
                            <input type="number" id="total-pkr" readonly class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100">
                        </div>
                        
                        <!-- Weight -->
                        <div>
                            <!-- UPDATED: Label changed -->
                            <label for="weight" class="block text-sm font-medium text-gray-700">WEIGHT</label>
                            <!-- UPDATED: Placeholder removed -->
                            <input type="number" id="weight" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>

                        <!-- Discount % -->
                        <div>
                            <label for="discount-percent" class="block text-sm font-medium text-gray-700">DISCOUNT %</label>
                            <input type="number" id="discount-percent" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>

                        <!-- Each Discount Amount -->
                        <div>
                            <label for="each-discount" class="block text-sm font-medium text-gray-700">EACH DISCOUNT AMOUNT</label>
                            <input type="number" id="each-discount" readonly class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100">
                        </div>

                        <!-- Commission Amount -->
                        <div>
                            <label for="commission" class="block text-sm font-medium text-gray-700">COMMISSION AMOUNT</label>
                            <input type="number" id="commission" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>

                        <!-- AFTER DISCOUNT (Read-only) -->
                        <div>
                            <label for="after-discount" class="block text-sm font-medium text-gray-700">AFTER DISCOUNT</label>
                            <input type="number" id="after-discount" readonly class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100">
                        </div>

                        <!-- TOTAL (Read-only) -->
                        <div>
                            <label for="total" class="block text-sm font-medium text-gray-700">TOTAL</label>
                            <input type="number" id="total" readonly class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100">
                        </div>

                        <!-- Add List Button -->
                        <div class="col-span-1 md:col-span-2 lg:col-span-3">
                            <button type="button" id="add-to-list-btn" class="w-full bg-green-600 text-white py-2 px-4 rounded-md shadow-lg hover:bg-green-700 transition duration-300 font-semibold mt-4">
                                Add to List
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Added List Table -->
                <!-- UPDATED: Reduced padding (p-6 to p-4) -->
                <div class="bg-white p-4 rounded-lg shadow-lg mt-6">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">Shipment List</h3>
                    <!-- UPDATED: Added overflow-x-auto, border, and rounded-lg -->
                    <div class="overflow-x-auto rounded-lg border border-gray-200">
                        <!-- UPDATED: Removed min-w-full, changed to w-full -->
                        <table class="w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <!-- UPDATED: Removed tracking-wider, added whitespace-normal -->
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase whitespace-normal">PRODUCTS CODE</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase whitespace-normal">BRAND NAME</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase whitespace-normal">QUANTITY</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase whitespace-normal">PKR</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase whitespace-normal">TOTAL PKR</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase whitespace-normal">WEIGHT (kg)</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase whitespace-normal">DISCOUNT %</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase whitespace-normal">EACH DISCOUNT AMOUNT</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase whitespace-normal">COMMISSION AMOUNT</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase whitespace-normal">AFTER DISCOUNT</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase whitespace-normal">SHIPMENT DATE</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase whitespace-normal">VENDOR NAME</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase whitespace-normal">TOTAL</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase whitespace-normal">Action</th>
                                </tr>
                            </thead>
                            <tbody id="temp-list-body" class="bg-white divide-y divide-gray-200">
                                <!-- Items will be added here by JS -->
                            </tbody>
                        </table>
                    </div>
                    <button id="save-shipment-btn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md shadow-lg hover:bg-blue-700 transition duration-300 font-semibold mt-4 hidden">
                        Save Shipment
                    </button>
                </div>
            </div>

            <!-- Page: Shipment Details -->
            <div id="shipment-details-page" class="app-page hidden">
                <!-- UPDATED: Reduced padding (p-6 to p-4) -->
                <div class="bg-white p-4 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">Shipment Details</h2>
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                        <div class="relative w-full sm:w-1/2">
                            <input type="text" id="search-box" placeholder="Search by PRODUCTS CODE"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <!-- UPDATED: Search button removed, will use 'Enter' key -->
                        </div>
                        <button id="download-details-btn" class="w-full sm:w-auto bg-green-600 text-white py-2 px-4 rounded-md shadow-lg hover:bg-green-700 transition font-semibold">
                            Download Excel
                        </button>
                    </div>
                    <!-- NEW: Div to show search total -->
                    <div id="search-total" class="text-lg font-semibold text-gray-700 mb-2 hidden"></div>
                    
                    <!-- UPDATED: Added overflow-x-auto, overflow-y-auto, max-h-[70vh], border, and rounded-lg -->
                    <div id="details-table-container" class="overflow-x-auto overflow-y-auto max-h-[70vh] rounded-lg border border-gray-200">
                        <!-- UPDATED: Removed min-w-full, changed to w-full -->
                        <table class="w-full divide-y divide-gray-200">
                            <!-- UPDATED: Added sticky top-0 z-5 for frozen header -->
                            <thead class="bg-gray-50 sticky top-0 z-5">
                                <tr id="details-table-head">
                                    <!-- Headers will be dynamically generated -->
                                </tr>
                            </thead>
                            <tbody id="details-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Data will be loaded here by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Page: Pricing -->
            <div id="pricing-page" class="app-page hidden">
                 <!-- UPDATED: Reduced padding (p-6 to p-4) -->
                 <div class="bg-white p-4 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">Pricing Report</h2>
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                        <div class="w-full sm:w-1/2">
                            <label for="pricing-date" class="block text-sm font-medium text-gray-700">Select Shipment Date</label>
                            <input type="date" id="pricing-date" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <!-- NEW: Span to show formatted pricing date -->
                            <span id="pricing-date-display" class="text-sm text-gray-500 font-medium"></span>
                        </div>
                        <button id="load-pricing-btn" class="w-full sm:w-auto bg-blue-500 text-white py-2 px-4 rounded-md shadow-lg hover:bg-blue-600 transition font-semibold">
                            Load Data
                        </button>
                        <button id="download-pricing-btn" class="w-full sm:w-auto bg-green-600 text-white py-2 px-4 rounded-md shadow-lg hover:bg-green-700 transition font-semibold disabled:opacity-50" disabled>
                            Download Excel
                        </button>
                    </div>
                    <!-- UPDATED: Added overflow-x-auto, border, and rounded-lg -->
                    <div class="overflow-x-auto rounded-lg border border-gray-200">
                        <!-- UPDATED: Removed min-w-full, changed to w-full -->
                        <table class="w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr id="pricing-table-head">
                                    <!-- Pricing headers (SL, CODE, etc.) -->
                                </tr>
                            </thead>
                            <tbody id="pricing-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Data will be loaded here by JS -->
                            </tbody>
                        </table>
                    </div>
                 </div>
            </div>
        </main>
    </div>
    
    <!-- Modal for Edit Shipment -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 hidden p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4">Edit Shipment Item</h3>
            <form id="edit-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Form fields will be dynamically injected here -->
            </form>
            <div class="mt-6 flex justify-end space-x-4">
                 <button id="cancel-edit-btn" class="bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600">Cancel</button>
                 <button id="update-shipment-btn" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">Update</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // === STATE ===
            const GAS_URL = 'https://script.google.com/macros/s/AKfycbyiC20R6jAeDfaLYjiWYEKM1uZpPo4KmV2BQiiNORAtZIy8oNYQsnDr6Ci3_FqVdXZk/exec';
            let state = {
                currentUser: null,
                brands: [],
                vendors: [],
                tempShipmentList: [],
                allShipments: [], // Holds the full list for the details page
                currentShipmentDetails: [], // Holds the currently *displayed* list (filtered or full)
                pricingData: [],
                editingRowId: null,
            };

            // === DOM ELEMENTS ===
            const loginPage = document.getElementById('login-page');
            const appPage = document.getElementById('app');
            const loginForm = document.getElementById('login-form');
            const loader = document.getElementById('loader-overlay');
            const alertBox = document.getElementById('alert-box');
            const alertMessage = document.getElementById('alert-message');
            const navButtons = document.querySelectorAll('.nav-button');
            const appPages = document.querySelectorAll('.app-page');
            const logoutButton = document.getElementById('logout-button');
            const menuItems = document.getElementById('menu-items');

            // Add Shipment Page
            const shipmentForm = document.getElementById('shipment-form');
            const productCodeInput = document.getElementById('product-code');
            const productHistoryDiv = document.getElementById('product-history');
            const brandNameInput = document.getElementById('brand-name');
            const addBrandBtn = document.getElementById('add-brand-btn');
            const brandListDatalist = document.getElementById('brand-list');
            const vendorNameInput = document.getElementById('vendor-name');
            const addVendorBtn = document.getElementById('add-vendor-btn');
            const vendorListDatalist = document.getElementById('vendor-list');
            const shipmentDateInput = document.getElementById('shipment-date');
            const dateDaySpan = document.getElementById('date-day');
            const quantityInput = document.getElementById('quantity');
            const pkrInput = document.getElementById('pkr');
            const totalPkrInput = document.getElementById('total-pkr');
            const weightInput = document.getElementById('weight');
            const discountPercentInput = document.getElementById('discount-percent');
            const eachDiscountInput = document.getElementById('each-discount');
            const commissionInput = document.getElementById('commission');
            const afterDiscountInput = document.getElementById('after-discount');
            const totalInput = document.getElementById('total');
            const addToListBtn = document.getElementById('add-to-list-btn');
            const tempListBody = document.getElementById('temp-list-body');
            const saveShipmentBtn = document.getElementById('save-shipment-btn');

            // Shipment Details Page
            const detailsPage = document.getElementById('shipment-details-page');
            const searchBox = document.getElementById('search-box');
            // const searchBtn = document.getElementById('search-btn'); // No longer needed
            const downloadDetailsBtn = document.getElementById('download-details-btn');
            const detailsTableHead = document.getElementById('details-table-head');
            const detailsTableBody = document.getElementById('details-table-body');
            const searchTotalDiv = document.getElementById('search-total');
            const editModal = document.getElementById('edit-modal');
            const editForm = document.getElementById('edit-form');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            const updateShipmentBtn = document.getElementById('update-shipment-btn');

            // Pricing Page
            const pricingPage = document.getElementById('pricing-page');
            const pricingDateInput = document.getElementById('pricing-date');
            const pricingDateDisplay = document.getElementById('pricing-date-display'); // NEW
            const loadPricingBtn = document.getElementById('load-pricing-btn');
            const downloadPricingBtn = document.getElementById('download-pricing-btn');
            const pricingTableHead = document.getElementById('pricing-table-head');
            const pricingTableBody = document.getElementById('pricing-table-body');
            
            const shipmentHeaders = ['PRODUCTS CODE', 'BRAND NAME', 'QUANTITY', 'PKR', 'TOTAL PKR', 'WEIGHT', 'DISCOUNT %', 'EACH DISCOUNT AMOUNT', 'COMMISSION AMOUNT', 'AFTER DISCOUNT', 'SHIPMENT DATE', 'VENDOR NAME', 'TOTAL'];
            const pricingHeaders = ['SL', 'CODE', 'QUANTITY', 'WEIGHT', 'PKR', 'BD', 'BUY', 'SELLING', 'PREVIOSE SELLING', 'ORGINAL RATE', 'BRAND NAME'];

            // === HELPER FUNCTIONS ===

            // Show/Hide Loader
            function showLoader(show = true) {
                loader.classList.toggle('hidden', !show);
            }

            // Show Alert
            function showAlert(message, isError = false) {
                alertMessage.textContent = message;
                alertBox.classList.remove('hidden', 'bg-green-500', 'bg-red-500', 'text-white');
                if (isError) {
                    alertBox.classList.add('bg-red-500', 'text-white');
                } else {
                    alertBox.classList.add('bg-green-500', 'text-white');
                }
                setTimeout(() => {
                    alertBox.classList.add('hidden');
                }, 3000);
            }

            // API Call Function
            async function apiCall(action, payload = {}) {
                showLoader();
                try {
                    const response = await fetch(GAS_URL, {
                        method: 'POST',
                        redirect: 'follow',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8', }, // Use utf-8
                        body: JSON.stringify({
                            action,
                            auth: state.currentUser, // Send auth details with every request
                            ...payload
                        })
                    });
                    const result = await response.json();
                    showLoader(false);
                    if (result.status === 'error') {
                        showAlert(result.message, true);
                        return null;
                    }
                    return result;
                } catch (error) {
                    showLoader(false);
                    showAlert('Network or API error: ' + error.message, true);
                    return null;
                }
            }

            // Page Navigation
            function showPage(pageId) {
                appPages.forEach(page => page.classList.add('hidden'));
                document.getElementById(pageId).classList.remove('hidden');

                navButtons.forEach(button => {
                    if (button.dataset.page === pageId) {
                        button.classList.remove('bg-gray-200', 'text-gray-700');
                        button.classList.add('bg-blue-500', 'text-white');
                    } else {
                        button.classList.add('bg-gray-200', 'text-gray-700');
                        button.classList.remove('bg-blue-500', 'text-white');
                    }
                });
                
                // Load data for page if needed
                if (pageId === 'shipment-details-page' && state.allShipments.length === 0) {
                    loadShipmentDetails();
                }
            }
            
            // Apply User Permissions
            function applyPermissions() {
                // Check for admin, case-insensitive
                const isAdmin = state.currentUser && state.currentUser.access && state.currentUser.access.toLowerCase() === 'admin';
                
                if (!isAdmin) {
                    // Hide admin-only menu items
                    menuItems.querySelector('[data-page="add-shipment-page"]').classList.add('hidden');
                    menuItems.querySelector('[data-page="pricing-page"]').classList.add('hidden');
                    
                    // Hide admin-only buttons in UI
                    if(addBrandBtn) addBrandBtn.classList.add('hidden');
                    if(addVendorBtn) addVendorBtn.classList.add('hidden');
                    if(addToListBtn) addToListBtn.classList.add('hidden');
                    if(saveShipmentBtn) saveShipmentBtn.classList.add('hidden');
                    if(downloadDetailsBtn) downloadDetailsBtn.classList.add('hidden');
                    
                    // Show Shipment Details by default for non-admin
                    showPage('shipment-details-page');
                } else {
                    // Show all elements for admin
                    menuItems.querySelector('[data-page="add-shipment-page"]').classList.remove('hidden');
                    menuItems.querySelector('[data-page="pricing-page"]').classList.remove('hidden');
                    showPage('add-shipment-page');
                }
            }
            
            // *** UPDATED: Helper to format date as "10 November 2025" ***
            function formatDateSimple(dateString) {
                if (!dateString) return '';
                
                let date;
                // Check if it's a full ISO string (from server) or just YYYY-MM-DD (from picker)
                if (dateString.includes('T')) {
                    date = new Date(dateString); // This is UTC, e.g., 2025-11-08T00:00:00Z
                } else {
                    // This is 'YYYY-MM-DD'. Parse it as local midnight to avoid shifting.
                    const parts = dateString.split('-');
                    if (parts.length === 3) {
                        // new Date(year, monthIndex, day)
                        date = new Date(parts[0], parts[1] - 1, parts[2]); 
                    } else {
                        date = new Date(dateString); // Fallback, though might be unreliable
                    }
                }
                
                return date.toLocaleDateString('en-GB', { 
                    day: 'numeric',
                    month: 'long', 
                    year: 'numeric' 
                });
            }

            // *** UPDATED: This function is still used by checkProductCode ***
            function formatDateWithDay(dateString) {
                if (!dateString) return '';

                let date;
                if (dateString.includes('T')) {
                    date = new Date(dateString);
                } else {
                    const parts = dateString.split('-');
                    if (parts.length === 3) {
                        date = new Date(parts[0], parts[1] - 1, parts[2]);
                    } else {
                        date = new Date(dateString); // Fallback
                    }
                }
                
                return date.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
            }


            // === LOGIN / LOGOUT ===
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const userName = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                const result = await apiCall('login', { userName, password });
                
                if (result && result.status === 'success') {
                    state.currentUser = { userName: result.userName, access: result.access };
                    localStorage.setItem('currentUser', JSON.stringify(state.currentUser)); 
                    
                    loginPage.classList.add('hidden');
                    appPage.classList.remove('hidden');
                    showAlert('Login successful!');
                    loadInitialData();
                    applyPermissions();
                }
            });

            logoutButton.addEventListener('click', () => {
                state.currentUser = null;
                localStorage.removeItem('currentUser'); 
                
                state.tempShipmentList = [];
                state.allShipments = [];
                state.currentShipmentDetails = [];
                state.brands = [];
                state.vendors = [];
                appPage.classList.add('hidden');
                loginPage.classList.remove('hidden');
                // Clear datalists
                brandListDatalist.innerHTML = '';
                vendorListDatalist.innerHTML = '';
                // Reset tables
                detailsTableBody.innerHTML = '';
                detailsTableHead.innerHTML = '';
                pricingTableBody.innerHTML = '';
                pricingTableHead.innerHTML = '';
            });
            
            // === INITIAL DATA LOAD ===
            async function loadInitialData() {
                const result = await apiCall('getInitialData');
                if (result) {
                    state.brands = result.brands;
                    state.vendors = result.vendors;
                    populateDatalists();
                }
            }
            
            function populateDatalists() {
                brandListDatalist.innerHTML = '';
                state.brands.forEach(brand => {
                    const option = document.createElement('option');
                    option.value = brand;
                    brandListDatalist.appendChild(option);
                });
                
                vendorListDatalist.innerHTML = '';
                state.vendors.forEach(vendor => {
                    const option = document.createElement('option');
                    option.value = vendor;
                    vendorListDatalist.appendChild(option);
                });
            }

            // === PWA Registration ===
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('sw.js')
                        .then(registration => console.log('ServiceWorker registration successful'))
                        .catch(err => console.log('ServiceWorker registration failed: ', err));
                });
            }

            // Check for saved user on page load
            (function checkSavedLogin() {
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    try {
                        state.currentUser = JSON.parse(savedUser);
                        if (state.currentUser && state.currentUser.userName) {
                            loginPage.classList.add('hidden');
                            appPage.classList.remove('hidden');
                            loadInitialData();
                            applyPermissions();
                            showAlert(`Welcome back, ${state.currentUser.userName}!`);
                        }
                    } catch (e) {
                        console.error('Failed to parse saved user', e);
                        localStorage.removeItem('currentUser');
                    }
                }
            })();
            
            // === PAGE NAVIGATION ===
            navButtons.forEach(button => {
                button.addEventListener('click', () => showPage(button.dataset.page));
            });

            // === ADD SHIPMENT PAGE ===
            
            // Set current date
            const today = new Date().toISOString().split('T')[0];
            shipmentDateInput.value = today;
            updateDateDay(today); // Use new function

            shipmentDateInput.addEventListener('change', (e) => updateDateDay(e.target.value));

            // UPDATED: This function now updates the span with "10 November 2025" format
            function updateDateDay(dateString) {
                if (!dateString) {
                    dateDaySpan.textContent = '';
                    return;
                }
                dateDaySpan.textContent = formatDateSimple(dateString);
            }

            // Calculations
            function updateCalculations() {
                const qty = parseFloat(quantityInput.value) || 0;
                const pkr = parseFloat(pkrInput.value) || 0;
                const eachDiscount = parseFloat(eachDiscountInput.value) || 0;
                const commission = parseFloat(commissionInput.value) || 0;
                
                const totalPkr = qty * pkr;
                const afterDiscount = pkr - eachDiscount + commission;
                const total = afterDiscount * qty;
                
                totalPkrInput.value = totalPkr.toFixed(0);
                afterDiscountInput.value = afterDiscount.toFixed(0);
                totalInput.value = total.toFixed(0);
            }

            function calculateEachDiscount() {
                const pkr = parseFloat(pkrInput.value) || 0;
                const discountPercent = parseFloat(discountPercentInput.value) || 0;
                const eachDiscount = pkr * (discountPercent / 100);
                eachDiscountInput.value = eachDiscount.toFixed(0);
                // Trigger other calculations that depend on this
                updateCalculations();
            }
            
            [quantityInput, pkrInput, commissionInput].forEach(input => {
                input.addEventListener('input', updateCalculations);
            });
            
            [pkrInput, discountPercentInput].forEach(input => {
                input.addEventListener('input', calculateEachDiscount);
            });

            // Product Code Check (on change)
            productCodeInput.addEventListener('change', async () => {
                const code = productCodeInput.value;
                if (code.length < 1) { // Changed from 3 to 1
                    productHistoryDiv.classList.add('hidden');
                    return;
                }
                const result = await apiCall('checkProductCode', { code });
                if (result && result.totalQty > 0) {
                    let historyHtml = `<strong>Previous Entries (${result.totalQty} Total):</strong><br>`;
                    result.history.forEach(item => {
                        // Use the original date formatter for this history view
                        historyHtml += `<span>${formatDateWithDay(item.date)}: ${item.qty} pcs</span><br>`;
                    });
                    productHistoryDiv.innerHTML = historyHtml;
                    productHistoryDiv.classList.remove('hidden');
                } else if (result) {
                    productHistoryDiv.textContent = 'No previous entries found.';
                    productHistoryDiv.classList.remove('hidden');
                } else {
                    // API call failed, hide the div
                    productHistoryDiv.classList.add('hidden');
                }
            });

            // Brand/Vendor Add Buttons
            brandNameInput.addEventListener('input', () => {
                const val = brandNameInput.value;
                const isAdmin = state.currentUser && state.currentUser.access && state.currentUser.access.toLowerCase() === 'admin';
                addBrandBtn.classList.toggle('hidden', !isAdmin || !val || state.brands.includes(val));
            });
            
            vendorNameInput.addEventListener('input', () => {
                const val = vendorNameInput.value;
                const isAdmin = state.currentUser && state.currentUser.access && state.currentUser.access.toLowerCase() === 'admin';
                addVendorBtn.classList.toggle('hidden', !isAdmin || !val || state.vendors.includes(val));
            });

            addBrandBtn.addEventListener('click', async () => {
                const brandName = brandNameInput.value;
                const result = await apiCall('addBrand', { brandName });
                if (result) {
                    state.brands.push(result.brandName);
                    populateDatalists();
                    addBrandBtn.classList.add('hidden');
                    showAlert(`Brand '${brandName}' added.`);
                }
            });
            
            addVendorBtn.addEventListener('click', async () => {
                const vendorName = vendorNameInput.value;
                const result = await apiCall('addVendor', { vendorName });
                if (result) {
                    state.vendors.push(result.vendorName);
                    populateDatalists();
                    addVendorBtn.classList.add('hidden');
                    showAlert(`Vendor '${vendorName}' added.`);
                }
            });


            // Function to reset only specific fields
            function resetAddShipmentForm() {
                productCodeInput.value = '';
                quantityInput.value = '';
                pkrInput.value = '';
                totalPkrInput.value = '';
                weightInput.value = '';
                discountPercentInput.value = '';
                eachDiscountInput.value = '';
                commissionInput.value = '';
                afterDiscountInput.value = '';
                totalInput.value = '';
                productHistoryDiv.classList.add('hidden');
            }

            // Add to List
            addToListBtn.addEventListener('click', () => {
                const item = {
                    productCode: productCodeInput.value,
                    brandName: brandNameInput.value,
                    quantity: parseFloat(quantityInput.value) || 0,
                    pkr: parseFloat(pkrInput.value) || 0,
                    totalPkr: parseFloat(totalPkrInput.value) || 0,
                    weight: (parseFloat(weightInput.value) || 0) / 1000, // Convert g to kg
                    discountPercent: parseFloat(discountPercentInput.value) || 0,
                    eachDiscountAmount: parseFloat(eachDiscountInput.value) || 0,
                    commissionAmount: parseFloat(commissionInput.value) || 0,
                    afterDiscount: parseFloat(afterDiscountInput.value) || 0,
                    shipmentDate: shipmentDateInput.value,
                    vendorName: vendorNameInput.value,
                    total: parseFloat(totalInput.value) || 0,
                    id: Date.now() // Unique ID for temp list
                };
                
                // Simple validation
                if (!item.productCode || !item.brandName || !item.quantity || !item.shipmentDate || !item.vendorName) {
                    showAlert('Please fill all required fields (Code, Brand, Qty, Date, Vendor).', true);
                    return;
                }
                
                state.tempShipmentList.push(item);
                renderTempList();
                
                // Call partial reset function
                resetAddShipmentForm(); 
            });
            
            function renderTempList() {
                tempListBody.innerHTML = '';
                if (state.tempShipmentList.length === 0) {
                    saveShipmentBtn.classList.add('hidden');
                    return;
                }
                
                state.tempShipmentList.forEach((item, index) => {
                    // UPDATED: Format date in the table
                    const formattedDate = formatDateSimple(item.shipmentDate);
                    // FIXED: Removed whitespace-nowrap, added whitespace-normal and break-words
                    const row = `
                        <tr data-id="${item.id}">
                            <td class="px-2 py-2 whitespace-normal break-words text-sm">${item.productCode}</td>
                            <td class="px-2 py-2 whitespace-normal break-words text-sm">${item.brandName}</td>
                            <td class="px-2 py-2 whitespace-normal break-words text-sm">${item.quantity.toFixed(0)}</td>
                            <td class="px-2 py-2 whitespace-normal break-words text-sm">${item.pkr.toFixed(2)}</td>
                            <td class="px-2 py-2 whitespace-normal break-words text-sm">${item.totalPkr.toFixed(2)}</td>
                            <td class="px-2 py-2 whitespace-normal break-words text-sm">${item.weight.toFixed(3)}</td>
                            <td class="px-2 py-2 whitespace-normal break-words text-sm">${item.discountPercent.toFixed(0)}</td>
                            <td class="px-2 py-2 whitespace-normal break-words text-sm">${item.eachDiscountAmount.toFixed(2)}</td>
                            <td class="px-2 py-2 whitespace-normal break-words text-sm">${item.commissionAmount.toFixed(2)}</td>
                            <td class="px-2 py-2 whitespace-normal break-words text-sm">${item.afterDiscount.toFixed(2)}</td>
                            <td class="px-2 py-2 whitespace-normal break-words text-sm">${formattedDate}</td>
                            <td class="px-2 py-2 whitespace-normal break-words text-sm">${item.vendorName}</td>
                            <td class="px-2 py-2 whitespace-normal break-words text-sm">${item.total.toFixed(2)}</td>
                            <td class="px-2 py-2 whitespace-normal break-words text-sm">
                                <button class="remove-item-btn text-red-500 hover:text-red-700" data-id="${item.id}">Remove</button>
                            </td>
                        </tr>
                    `;
                    tempListBody.innerHTML += row;
                });
                
                // Add event listeners to new remove buttons
                document.querySelectorAll('.remove-item-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = parseInt(e.target.dataset.id);
                        state.tempShipmentList = state.tempShipmentList.filter(item => item.id !== id);
                        renderTempList();
                    });
                });
                
                saveShipmentBtn.classList.remove('hidden');
            }
            
            // Save Shipment
            saveShipmentBtn.addEventListener('click', async () => {
                const result = await apiCall('saveShipment', { items: state.tempShipmentList });
                if (result) {
                    showAlert(`Successfully saved ${result.saved} items.`);
                    state.tempShipmentList = [];
                    renderTempList();
                    // Clear the main shipment list cache to force refresh
                    state.allShipments = []; 
                }
            });

            // === SHIPMENT DETAILS PAGE ===
            
            async function loadShipmentDetails() {
                const result = await apiCall('getShipmentDetails');
                if (result) {
                    state.allShipments = result.data;
                    state.currentShipmentDetails = state.allShipments; // By default, show all
                    renderDetailsTable(state.currentShipmentDetails);
                }
            }
            
            function renderDetailsTable(data) {
                if (data.length === 0) {
                    detailsTableHead.innerHTML = '';
                    detailsTableBody.innerHTML = '<tr><td colspan="100%" class="text-center p-4">No data found.</td></tr>';
                    return;
                }
                
                // Create headers
                const headers = Object.keys(data[0]).filter(h => h !== 'rowId');
                let headHtml = '';
                headers.forEach(h => {
                    // UPDATED: Removed tracking-wider, added whitespace-normal to allow header wrapping
                    headHtml += `<th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase whitespace-normal">${h}</th>`;
                });
                // Case-insensitive admin check
                const isAdmin = state.currentUser && state.currentUser.access && state.currentUser.access.toLowerCase() === 'admin';
                if (isAdmin) {
                    // UPDATED: Reduced padding (px-3 to px-2, py-3 to py-2)
                    headHtml += `<th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase whitespace-normal">Actions</th>`;
                }
                detailsTableHead.innerHTML = `<tr>${headHtml}</tr>`;
                
                // Create body
                let bodyHtml = '';
                data.forEach(item => {
                    bodyHtml += `<tr data-row-id="${item.rowId}">`;
                    headers.forEach(header => {
                        let value = item[header];
                        
                        // *** UPDATED: Apply number formatting ***
                        const moneyHeaders = ['PKR', 'TOTAL PKR', 'EACH DISCOUNT AMOUNT', 'COMMISSION AMOUNT', 'AFTER DISCOUNT', 'TOTAL'];

                        if (header === 'SHIPMENT DATE' && value) {
                            value = formatDateSimple(value);
                        } else if (header === 'WEIGHT' && value) {
                            value = (parseFloat(value) || 0).toFixed(3);
                        } else if (header === 'QUANTITY' && value) {
                            value = (parseFloat(value) || 0).toFixed(0);
                        } else if (header === 'DISCOUNT %' && value) {
                            value = (parseFloat(value) || 0).toFixed(0);
                        } else if (moneyHeaders.includes(header) && (value || value === 0)) {
                            value = (parseFloat(value) || 0).toFixed(2); // <-- FIX for .650000001
                        }
                        // *** END OF UPDATE ***

                        // UPDATED: Removed whitespace-nowrap, added whitespace-normal and break-words
                        bodyHtml += `<td class="px-2 py-2 whitespace-normal break-words text-sm">${value}</td>`;
                    });
                    if (isAdmin) {
                        // UPDATED: Reduced padding (px-3 to px-2, py-2)
                        bodyHtml += `<td class="px-2 py-2 whitespace-normal break-words text-sm">
                                       <button class="edit-btn text-blue-500 hover:text-blue-700" data-row-id="${item.rowId}">Edit</button>
                                   </td>`;
                    }
                    bodyHtml += `</tr>`;
                });
                detailsTableBody.innerHTML = bodyHtml;
                
                // Add edit button listeners
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => openEditModal(e.target.dataset.rowId));
                });
            }

            // *** UPDATED: Real-time, partial search on the 'input' event ***
            searchBox.addEventListener('input', () => {
                const searchTerm = searchBox.value.toLowerCase();
                
                if (!searchTerm) {
                    // If search is empty, show all shipments
                    state.currentShipmentDetails = state.allShipments;
                    searchTotalDiv.classList.add('hidden'); // Hide total
                } else {
                    // Filter the *already loaded* allShipments array
                    state.currentShipmentDetails = state.allShipments.filter(item => {
                        // Ensure 'PRODUCTS CODE' exists and is a string before calling toLowerCase
                        const productCode = (item['PRODUCTS CODE'] || '').toString().toLowerCase();
                        // Check if product code *includes* the search term
                        return productCode.includes(searchTerm);
                    });

                    // Show total for filtered results
                    if (state.currentShipmentDetails.length > 0) {
                        const totalQty = state.currentShipmentDetails.reduce((sum, item) => sum + (parseFloat(item['QUANTITY']) || 0), 0);
                        searchTotalDiv.textContent = `Found ${state.currentShipmentDetails.length} items - Total Quantity: ${totalQty}`;
                        searchTotalDiv.classList.remove('hidden');
                    } else {
                        searchTotalDiv.textContent = 'No items matching search.';
                        searchTotalDiv.classList.remove('hidden');
                    }
                }
                
                // Re-render the table with the filtered data
                renderDetailsTable(state.currentShipmentDetails);
            });
            
            // The old 'searchBox.addEventListener('keyup', ...)' for 'Enter' is now REMOVED.

            downloadDetailsBtn.addEventListener('click', () => {
                // Download only the *currently displayed* data
                const dataToDownload = state.currentShipmentDetails.map(item => {
                    // Create a new object to avoid modifying the state
                    const newItem = {...item};
                    delete newItem.rowId; // Remove rowId for download
                    
                    // *** UPDATED: Format date for Excel download ***
                    if (newItem['SHIPMENT DATE']) {
                        newItem['SHIPMENT DATE'] = formatDateSimple(newItem['SHIPMENT DATE']);
                    }

                    // *** UPDATED: Format numbers for Excel download ***
                    const moneyHeaders = ['PKR', 'TOTAL PKR', 'EACH DISCOUNT AMOUNT', 'COMMISSION AMOUNT', 'AFTER DISCOUNT', 'TOTAL'];
                    if (newItem['WEIGHT']) newItem['WEIGHT'] = (parseFloat(newItem['WEIGHT']) || 0).toFixed(3);
                    if (newItem['QUANTITY']) newItem['QUANTITY'] = (parseFloat(newItem['QUANTITY']) || 0).toFixed(0);
                    if (newItem['DISCOUNT %']) newItem['DISCOUNT %'] = (parseFloat(newItem['DISCOUNT %']) || 0).toFixed(0);
                    moneyHeaders.forEach(header => {
                        if (newItem[header] || newItem[header] === 0) {
                            newItem[header] = (parseFloat(newItem[header]) || 0).toFixed(2);
                        }
                    });

                    return newItem;
                });
                
                const ws = XLSX.utils.json_to_sheet(dataToDownload);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Shipment Details');
                XLSX.writeFile(wb, 'Shipment_Details.xlsx');
            });

            // === EDIT MODAL ===
            function openEditModal(rowId) {
                const item = state.allShipments.find(s => s.rowId == rowId);
                if (!item) return;
                
                state.editingRowId = rowId;
                editForm.innerHTML = ''; // Clear previous form
                
                const itemKeys = {
                    'PRODUCTS CODE': 'productCode',
                    'BRAND NAME': 'brandName',
                    'QUANTITY': 'quantity',
                    'PKR': 'pkr',
                    'TOTAL PKR': 'totalPkr',
                    'WEIGHT': 'weight',
                    'DISCOUNT %': 'discountPercent',
                    'EACH DISCOUNT AMOUNT': 'eachDiscountAmount',
                    'COMMISSION AMOUNT': 'commissionAmount',
                    'AFTER DISCOUNT': 'afterDiscount',
                    'SHIPMENT DATE': 'shipmentDate',
                    'VENDOR NAME': 'vendorName',
                    'TOTAL': 'total',
                };

                shipmentHeaders.forEach(header => {
                    const key = itemKeys[header];
                    let value = item[header];
                    let inputType = 'text';
                    let isReadOnly = false;
                    let listName = '';
                    let extraHtml = ''; // To add formatted date
                    
                    if (['TOTAL PKR', 'EACH DISCOUNT AMOUNT', 'AFTER DISCOUNT', 'TOTAL'].includes(header)) {
                        isReadOnly = true;
                    }

                    if (header === 'BRAND NAME') listName = 'brand-list';
                    if (header === 'VENDOR NAME') listName = 'vendor-list';
                    
                    if (typeof value === 'number' || ['QUANTITY', 'PKR', 'WEIGHT', 'DISCOUNT %', 'COMMISSION AMOUNT'].includes(header)) {
                        inputType = 'number';
                    }
                    if (header === 'SHIPMENT DATE' && value) {
                        inputType = 'date';
                        const dateObj = new Date(value);
                        // Format to YYYY-MM-DD for the input value
                        const year = dateObj.getFullYear();
                        const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
                        const day = dateObj.getDate().toString().padStart(2, '0');
                        value = `${year}-${month}-${day}`;
                        
                        // Add span to show formatted date
                        // We must pass the original full date string (or object) to formatDateSimple
                        extraHtml = `<span class="text-sm text-gray-500 font-medium">${formatDateSimple(item[header])}</span>`;
                    }
                    if (header === 'WEIGHT' && value) {
                        value = (parseFloat(value) || 0) * 1000; // Convert kg back to g
                    }
                    
                    editForm.innerHTML += `
                        <div>
                            <label for="edit-${key}" class="block text-sm font-medium text-gray-700">${header}</label>
                            <input type="${inputType}" id="edit-${key}" data-key="${key}" data-header="${header}" value="${value}"
                                   ${listName ? `list="${listName}"` : ''}
                                   ${isReadOnly ? 'readonly' : ''}
                                   class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 ${isReadOnly ? 'bg-gray-100' : ''}">
                            ${extraHtml}
                        </div>
                    `;
                });

                // Add event listener to the new date input in the modal
                const editDateInput = document.getElementById('edit-shipmentDate');
                if (editDateInput) {
                    editDateInput.addEventListener('change', (e) => {
                        const displaySpan = e.target.nextElementSibling;
                        if (displaySpan) {
                            displaySpan.textContent = formatDateSimple(e.target.value);
                        }
                    });
                }
                
                // Add calculation logic to edit modal inputs
                const editQty = document.getElementById('edit-quantity');
                const editPkr = document.getElementById('edit-pkr');
                const editTotalPkr = document.getElementById('edit-totalPkr');
                const editDiscountPercent = document.getElementById('edit-discountPercent');
                const editEachDiscount = document.getElementById('edit-eachDiscountAmount');
                const editCommission = document.getElementById('edit-commissionAmount'); 
                const editAfterDiscount = document.getElementById('edit-afterDiscount');
                const editTotal = document.getElementById('edit-total');

                function calculateEditEachDiscount() {
                    const pkr = parseFloat(editPkr.value) || 0;
                    const discountPercent = parseFloat(editDiscountPercent.value) || 0;
                    const eachDiscount = pkr * (discountPercent / 100);
                    editEachDiscount.value = eachDiscount.toFixed(0);
                    updateEditCalculations(); // Trigger main calculation
                }

                function updateEditCalculations() {
                    const qty = parseFloat(editQty.value) || 0;
                    const pkr = parseFloat(editPkr.value) || 0;
                    const eachDiscount = parseFloat(editEachDiscount.value) || 0;
                    const commission = parseFloat(editCommission.value) || 0;
                    
                    const totalPkr = qty * pkr;
                    const afterDiscount = pkr - eachDiscount + commission;
                    const total = afterDiscount * qty;
                    
                    editTotalPkr.value = totalPkr.toFixed(0);
                    editAfterDiscount.value = afterDiscount.toFixed(0);
                    editTotal.value = total.toFixed(0);
                }

                // Attach listeners
                [editQty, editPkr, editCommission].forEach(input => {
                    if(input) input.addEventListener('input', updateEditCalculations);
                });
                
                [editPkr, editDiscountPercent].forEach(input => {
                    if(input) input.addEventListener('input', calculateEditEachDiscount);
                });

                editModal.classList.remove('hidden');
            }
            
            cancelEditBtn.addEventListener('click', () => {
                editModal.classList.add('hidden');
                state.editingRowId = null;
            });
            
            updateShipmentBtn.addEventListener('click', async () => {
                const updatedItem = {};
                editForm.querySelectorAll('input').forEach(input => {
                    const key = input.dataset.key;
                    const header = input.dataset.header;
                    let value = input.value;
                    if (input.type === 'number') value = parseFloat(value) || 0;
                    if (input.type === 'date') {
                        // input.value is 'YYYY-MM-DD'. We need to convert it to a Date object.
                        // By creating it this way, it's local midnight, which GAS will handle correctly.
                        const parts = input.value.split('-');
                        value = new Date(parts[0], parts[1] - 1, parts[2]); 
                    }
                    
                    if (header === 'WEIGHT') {
                        value = (parseFloat(input.value) || 0) / 1000; // Convert g to kg
                    }

                    updatedItem[key] = value;
                });
                
                const result = await apiCall('updateShipment', { rowId: state.editingRowId, data: updatedItem });
                
                if (result) {
                    showAlert('Shipment updated successfully.');
                    editModal.classList.add('hidden');
                    loadShipmentDetails(); // Refresh data
                }
            });

            // === PRICING PAGE ===

            // NEW: Add listener to update display span
            pricingDateInput.addEventListener('change', (e) => {
                if (!e.target.value) {
                    pricingDateDisplay.textContent = '';
                    return;
                }
                pricingDateDisplay.textContent = formatDateSimple(e.target.value);
            });

            loadPricingBtn.addEventListener('click', async () => {
                const date = pricingDateInput.value;
                if (!date) {
                    showAlert('Please select a date.', true);
                    return;
                }
                
                const result = await apiCall('getPricingData', { date });
                
                if (result && result.data.length > 0) {
                    state.pricingData = result.data;
                    renderPricingTable(result.data);
                    downloadPricingBtn.disabled = false;
                } else {
                    state.pricingData = [];
                    pricingTableHead.innerHTML = '';
                    pricingTableBody.innerHTML = '<tr><td colspan="100%" class="text-center p-4">No data found for this date.</td></tr>';
                    downloadPricingBtn.disabled = true;
                }
            });
            
            function renderPricingTable(data) {
                // Headers
                // UPDATED: Removed tracking-wider, added whitespace-normal
                pricingTableHead.innerHTML = `<tr>${pricingHeaders.map(h => `<th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase whitespace-normal">${h}</th>`).join('')}</tr>`;
                
                // Body
                let bodyHtml = '';
                data.forEach((item, index) => {
                    bodyHtml += '<tr>';
                    // UPDATED: Reduced padding (px-3 to px-2, py-2)
                    // *** UPDATED: Apply number formatting ***
                    // *** UPDATED: Removed whitespace-nowrap, added whitespace-normal and break-words ***
                    bodyHtml += `<td class="px-2 py-2 whitespace-normal break-words text-sm">${index + 1}</td>`; // SL
                    bodyHtml += `<td class="px-2 py-2 whitespace-normal break-words text-sm">${item['PRODUCTS CODE']}</td>`; // CODE
                    bodyHtml += `<td class="px-2 py-2 whitespace-normal break-words text-sm">${(parseFloat(item['QUANTITY']) || 0).toFixed(0)}</td>`; // QUANTITY
                    bodyHtml += `<td class="px-2 py-2 whitespace-normal break-words text-sm">${(parseFloat(item['WEIGHT']) || 0).toFixed(3)}</td>`; // WEIGHT
                    bodyHtml += `<td class="px-2 py-2 whitespace-normal break-words text-sm">${(parseFloat(item['AFTER DISCOUNT']) || 0).toFixed(2)}</td>`; // PKR (from AFTER DISCOUNT)
                    bodyHtml += `<td class="px-2 py-2 whitespace-normal break-words text-sm"></td>`; // BD (empty)
                    bodyHtml += `<td class="px-2 py-2 whitespace-normal break-words text-sm"></td>`; // BUY (empty)
                    bodyHtml += `<td class="px-2 py-2 whitespace-normal break-words text-sm"></td>`; // SELLING (empty)
                    bodyHtml += `<td class="px-2 py-2 whitespace-normal break-words text-sm"></td>`; // PREVIOSE SELLING (empty)
                    bodyHtml += `<td class="px-2 py-2 whitespace-normal break-words text-sm">${(parseFloat(item['PKR']) || 0).toFixed(2)}</td>`; // ORGINAL RATE (from PKR)
                    bodyHtml += `<td class="px-2 py-2 whitespace-normal break-words text-sm">${item['BRAND NAME']}</td>`; // BRAND NAME
                    bodyHtml += '</tr>';
                });
                pricingTableBody.innerHTML = bodyHtml;
            }

            downloadPricingBtn.addEventListener('click', () => {
                const dataToDownload = state.pricingData.map((item, index) => ({
                    'SL': index + 1,
                    'CODE': item['PRODUCTS CODE'],
                    'QUANTITY': (parseFloat(item['QUANTITY']) || 0).toFixed(0),
                    'WEIGHT': (parseFloat(item['WEIGHT']) || 0).toFixed(3), // Format weight
                    'PKR': (parseFloat(item['AFTER DISCOUNT']) || 0).toFixed(2),
                    'BD': '',
                    'BUY': '',
                    'SELLING': '',
                    'PREVIOSE SELLING': '',
                    'ORGINAL RATE': (parseFloat(item['PKR']) || 0).toFixed(2),
                    'BRAND NAME': item['BRAND NAME']
                }));
                
                const ws = XLSX.utils.json_to_sheet(dataToDownload, { header: pricingHeaders });
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Pricing Report');
                XLSX.writeFile(wb, `Pricing_Report_${pricingDateInput.value}.xlsx`);
            });

        });
    </script>
</body>
</html>
