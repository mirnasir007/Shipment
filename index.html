<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shipment Management App</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Simple Inter font */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 10px; }
        
        /* Custom Modal Styles */
        #custom-modal-backdrop {
            transition: opacity 0.2s ease-in-out;
        }
        #custom-modal-box {
            transition: transform 0.2s ease-in-out;
        }
        
        /* Loading Spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 bg-gray-800 z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h2 class="text-3xl font-bold text-center mb-6">Shipment App Login</h2>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                    <input type="text" id="username" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div id="login-error" class="text-sm text-red-600 hidden"></div>
                <div>
                    <button type="submit" id="login-button" class="w-full py-2 px-4 bg-blue-600 text-white rounded-md hover:bg-blue-700 font-semibold flex items-center justify-center">
                        Login
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main App (Initially Hidden) -->
    <div id="main-app" class="flex h-screen hidden">
        <!-- Sidebar Navigation -->
        <aside class="w-64 bg-gray-800 text-white flex flex-col fixed h-full">
            <div class="p-5 border-b border-gray-700">
                <h1 class="text-2xl font-bold text-center">Shipment App</h1>
            </div>
            <nav class="flex-grow p-4 space-y-2">
                <!-- Menu Link: Add Shipment -->
                <a href="#" 
                   id="menu-add-shipment"
                   class="menu-link flex items-center px-4 py-3 rounded-lg transition-all duration-200" 
                   data-target="page-add-shipment">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    Add Shipment
                </a>

                <!-- Menu Link: Shipment Details -->
                <a href="#" 
                   id="menu-details"
                   class="menu-link flex items-center px-4 py-3 rounded-lg transition-all duration-200" 
                   data-target="page-details">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" />
                        <path fill-rule="evenodd" d="M4 5a2 2 0 012-2h8a2 2 0 012 2v10a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h6a1 1 0 100-2H7zm0 4a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                    </svg>
                    Shipment Details
                </a>

                <!-- Menu Link: Priceing (Pricing) -->
                <a href="#" 
                   id="menu-priceing"
                   class="menu-link flex items-center px-4 py-3 rounded-lg transition-all duration-200" 
                   data-target="page-priceing">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M8.433 7.418c.155-.103.346-.103.501 0l3.13 2.087a.25.25 0 010 .416l-3.13 2.087a.25.25 0 01-.501 0v-4.174z" />
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm0 1a9 9 0 100-18 9 9 0 000 18z" clip-rule="evenodd" />
                    </svg>
                    Priceing
                </a>
            </nav>
            <div class="p-4 border-t border-gray-700 text-center text-sm text-gray-400">
                &copy; 2025 Your Company
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-grow p-8 ml-64 overflow-auto">
            
            <!-- Page 1: Add Shipment (Default) -->
            <div id="page-add-shipment" class="page-content">
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h2 class="text-3xl font-bold mb-6 border-b pb-4">Add New Shipment</h2>
                    
                    <!-- Shipment Form -->
                    <form id="shipment-form" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <!-- PRODUCTS CODE -->
                            <div class="col-span-1 md:col-span-1">
                                <label for="product-code" class="block text-sm font-medium text-gray-700">Products Code</label>
                                <input type="text" id="product-code" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <div id="product-history-results" class="mt-2 text-xs space-y-1"></div>
                            </div>

                            <!-- BRAND NAME -->
                            <div class="col-span-1 md:col-span-1">
                                <label for="brand-name" class="block text-sm font-medium text-gray-700">Brand Name</label>
                                <div class="flex">
                                    <input type="text" id="brand-name" list="brand-suggestions-list" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-l-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <datalist id="brand-suggestions-list"></datalist>
                                    <button type="button" id="add-brand-btn" class="hidden mt-1 px-3 py-2 bg-green-500 text-white rounded-r-md hover:bg-green-600">Add</button>
                                </div>
                            </div>

                            <!-- QUANTITY -->
                            <div>
                                <label for="quantity" class="block text-sm font-medium text-gray-700">Quantity</label>
                                <input type="number" id="quantity" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>

                            <!-- PKR -->
                            <div>
                                <label for="pkr" class="block text-sm font-medium text-gray-700">PKR</label>
                                <input type="number" id="pkr" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>

                            <!-- TOTAL PKR (Auto) -->
                            <div>
                                <label for="total-pkr" class="block text-sm font-medium text-gray-700">Total PKR</label>
                                <input type="text" id="total-pkr" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100" readonly>
                            </div>

                            <!-- WEIGHT -->
                            <div>
                                <label for="weight" class="block text-sm font-medium text-gray-700">Weight</label>
                                <input type="number" id="weight" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>

                            <!-- DISCOUNT % -->
                            <div>
                                <label for="discount-percent" class="block text-sm font-medium text-gray-700">Discount %</label>
                                <input type="number" id="discount-percent" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>

                            <!-- EACH DISCOUNT AMOUNT (Auto) -->
                            <div>
                                <label for="each-discount" class="block text-sm font-medium text-gray-700">Each Discount Amount</label>
                                <input type="text" id="each-discount" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100" readonly>
                            </div>

                            <!-- COMMISSION AMOUNT -->
                            <div>
                                <label for="commission" class="block text-sm font-medium text-gray-700">Commission Amount</label>
                                <input type="number" id="commission" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>

                            <!-- AFTER DISCOUNT (Auto) -->
                            <div>
                                <label for="after-discount" class="block text-sm font-medium text-gray-700">After Discount</label>
                                <input type="text" id="after-discount" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100" readonly>
                            </div>
                            
                            <!-- SHIPMENT DATE -->
                            <div>
                                <label for="shipment-date" class="block text-sm font-medium text-gray-700">Shipment Date</label>
                                <input type="date" id="shipment-date" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <span id="date-day" class="text-sm text-gray-500 ml-2"></span>
                            </div>

                            <!-- VENDOR NAME -->
                            <div>
                                <label for="vendor-name" class="block text-sm font-medium text-gray-700">Vendor Name</label>
                                <div class="flex">
                                    <select id="vendor-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-l-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">Select Vendor</option>
                                    </select>
                                    <button type="button" id="add-vendor-btn" class="mt-1 px-3 py-2 bg-blue-500 text-white rounded-r-md hover:bg-blue-600">+</button>
                                </div>
                            </div>
                            
                            <!-- TOTAL (Auto) -->
                            <div class="col-span-1 md:col-span-2 lg:col-span-4">
                                <label for="total" class="block text-sm font-medium text-gray-700">Total</label>
                                <input type="text" id="total" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100" readonly>
                            </div>
                        </div>

                        <!-- Add List Button -->
                        <div class="text-right">
                            <button type="button" id="add-to-list-btn" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 font-semibold">
                                Add List
                            </button>
                        </div>
                    </form>

                    <!-- Shipment List Table -->
                    <div class="mt-10">
                        <h3 class="text-2xl font-bold mb-4">Shipment List</h3>
                        <div class="overflow-x-auto">
                            <table id="shipment-list-table" class="min-w-full bg-white border border-gray-300">
                                <thead class="bg-gray-800 text-white">
                                    <tr>
                                        <th class="py-2 px-3 text-left text-xs">Product Code</th>
                                        <th class="py-2 px-3 text-left text-xs">Brand</th>
                                        <th class="py-2 px-3 text-left text-xs">Qty</th>
                                        <th class="py-2 px-3 text-left text-xs">PKR</th>
                                        <th class="py-2 px-3 text-left text-xs">After Disc.</th>
                                        <th class="py-2 px-3 text-left text-xs">Total</th>
                                        <th class="py-2 px-3 text-left text-xs">Date</th>
                                        <th class="py-2 px-3 text-left text-xs">Vendor</th>
                                        <th class="py-2 px-3 text-left text-xs">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="shipment-list-body"></tbody>
                            </table>
                        </div>
                        <div class="text-right mt-6">
                            <button id="save-shipment-btn" class="px-8 py-3 bg-green-600 text-white rounded-md hover:bg-green-700 font-bold text-lg flex items-center justify-center float-right">
                                Save Shipment
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page 2: Shipment Details (Hidden) -->
            <div id="page-details" class="page-content hidden">
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h2 class="text-3xl font-bold mb-6 border-b pb-4">Shipment Details</h2>
                    <p>Ekhane Google Sheet theke data ene shob shipment-er details dekhano hobe.</p>
                    <div class="mt-4">
                        <p class="text-gray-600">Loading shipment data... (Feature under development)</p>
                    </div>
                </div>
            </div>

            <!-- Page 3: Priceing (Hidden) -->
            <div id="page-priceing" class="page-content hidden">
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h2 class="text-3xl font-bold mb-6 border-b pb-4">Priceing</h2>
                    <p>Ekhane apnar pricing details ba calculation-er information thakbe. (Feature under development)</p>
                </div>
            </div>

        </main>
    </div>

    <!-- Custom Modal -->
    <div id="custom-modal" class="fixed inset-0 z-[100] hidden">
        <!-- Backdrop -->
        <div id="custom-modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50"></div>
        
        <!-- Modal Box -->
        <div class="flex items-center justify-center min-h-screen">
            <div id="custom-modal-box" class_name="bg-white p-6 rounded-lg shadow-xl w-full max-w-md transform scale-95">
                <h3 id="custom-modal-title" class="text-2xl font-bold mb-4">Notification</h3>
                <p id="custom-modal-message" class="text-gray-700 mb-6"></p>
                <div class="text-right space-x-2">
                    <button id="custom-modal-confirm-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">OK</button>
                    <button id="custom-modal-cancel-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            // --- Global Variables ---
            const GAS_URL = 'https://script.google.com/macros/s/AKfycbyiC20R6jAeDfaLYjiWYEKM1uZpPo4KmV2BQiiNORAtZIy8oNYQsnDr6Ci3_FqVdXZk/exec';
            let userAccessLevel = 'viewer'; // Default access
            let shipmentList = []; // Joto item list-e add hobe
            
            // --- Modal Elements ---
            const modal = document.getElementById('custom-modal');
            const modalBackdrop = document.getElementById('custom-modal-backdrop');
            const modalBox = document.getElementById('custom-modal-box');
            const modalTitle = document.getElementById('custom-modal-title');
            const modalMessage = document.getElementById('custom-modal-message');
            const modalConfirmBtn = document.getElementById('custom-modal-confirm-btn');
            const modalCancelBtn = document.getElementById('custom-modal-cancel-btn');
            let confirmCallback = null;

            // --- Custom Modal Functions ---
            function showModal(message, title = 'Notification') {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modalConfirmBtn.textContent = 'OK';
                modalCancelBtn.classList.add('hidden');
                modal.classList.remove('hidden');
                modalBackdrop.classList.remove('opacity-0');
                modalBox.classList.remove('scale-95');
                confirmCallback = null;
            }

            function showConfirm(message, callback, title = 'Confirmation') {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modalConfirmBtn.textContent = 'OK';
                modalCancelBtn.classList.remove('hidden');
                modal.classList.remove('hidden');
                modalBackdrop.classList.remove('opacity-0');
                modalBox.classList.remove('scale-95');
                confirmCallback = callback; // Store the function to call on confirm
            }

            function hideModal() {
                modalBackdrop.classList.add('opacity-0');
                modalBox.classList.add('scale-95');
                setTimeout(() => modal.classList.add('hidden'), 200);
            }

            modalConfirmBtn.addEventListener('click', () => {
                hideModal();
                if (confirmCallback) {
                    confirmCallback(true); // User clicked OK
                }
            });
            modalCancelBtn.addEventListener('click', () => {
                hideModal();
                if (confirmCallback) {
                    confirmCallback(false); // User clicked Cancel
                }
            });
            modalBackdrop.addEventListener('click', hideModal);

            // --- Loading State Function ---
            function showLoading(button, show = true, defaultText = '') {
                if (show) {
                    button.disabled = true;
                    button.innerHTML = `<div class="loader mx-auto"></div>`;
                } else {
                    button.disabled = false;
                    button.innerHTML = defaultText;
                }
            }

            // --- Login Logic ---
            const loginForm = document.getElementById('login-form');
            const loginButton = document.getElementById('login-button');
            const loginError = document.getElementById('login-error');
            const mainApp = document.getElementById('main-app');

            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                showLoading(loginButton, true, 'Login');
                loginError.classList.add('hidden');

                fetch(`${GAS_URL}?action=checkPassword&username=${username}&password=${password}`)
                    .then(res => res.json())
                    .then(data => {
                        showLoading(loginButton, false, 'Login');
                        if (data.success) {
                            userAccessLevel = data.access; // 'admin' or 'viewer'
                            document.getElementById('login-screen').classList.add('hidden');
                            mainApp.classList.remove('hidden');
                            applyPermissions();
                            loadVendors(); // Load vendors after successful login
                        } else {
                            loginError.textContent = data.message;
                            loginError.classList.remove('hidden');
                        }
                    })
                    .catch(err => {
                        showLoading(loginButton, false, 'Login');
                        loginError.textContent = 'Error: Could not connect. Please try again.';
                        loginError.classList.remove('hidden');
                    });
            });

            // --- Permission Logic ---
            function applyPermissions() {
                if (userAccessLevel === 'viewer') {
                    // Viewer access
                    document.getElementById('menu-add-shipment').classList.add('hidden');
                    document.getElementById('menu-priceing').classList.add('hidden');
                    // Hide Add/Save buttons
                    document.getElementById('add-to-list-btn').classList.add('hidden');
                    document.getElementById('save-shipment-btn').classList.add('hidden');
                    document.getElementById('add-vendor-btn').classList.add('hidden');
                    // Make form read-only
                    document.querySelectorAll('#shipment-form input, #shipment-form select').forEach(el => el.disabled = true);
                    
                    // Show details page by default
                    showPage('page-details');
                } else {
                    // Admin access
                    showPage('page-add-shipment'); // Default page for admin
                }
            }

            // --- Page Navigation Logic ---
            const menuLinks = document.querySelectorAll('.menu-link');
            const pages = document.querySelectorAll('.page-content');

            function showPage(targetId) {
                pages.forEach(page => page.classList.add('hidden'));
                const targetPage = document.getElementById(targetId);
                if (targetPage) targetPage.classList.remove('hidden');

                menuLinks.forEach(link => {
                    if (link.dataset.target === targetId) {
                        link.classList.add('bg-blue-600', 'text-white');
                        link.classList.remove('text-gray-300', 'hover:bg-gray-700');
                    } else {
                        link.classList.remove('bg-blue-600', 'text-white');
                        link.classList.add('text-gray-300', 'hover:bg-gray-700');
                    }
                });
            }

            menuLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    showPage(e.currentTarget.dataset.target);
                });
            });

            // --- Add Shipment Page Logic ---
            
            // Form fields
            const productCodeInput = document.getElementById('product-code');
            const brandNameInput = document.getElementById('brand-name');
            const quantityInput = document.getElementById('quantity');
            const pkrInput = document.getElementById('pkr');
            const weightInput = document.getElementById('weight');
            const discountPercentInput = document.getElementById('discount-percent');
            const commissionInput = document.getElementById('commission');
            const shipmentDateInput = document.getElementById('shipment-date');
            const vendorNameSelect = document.getElementById('vendor-name');
            const totalPkrInput = document.getElementById('total-pkr');
            const eachDiscountInput = document.getElementById('each-discount');
            const afterDiscountInput = document.getElementById('after-discount');
            const totalInput = document.getElementById('total');
            const dateDaySpan = document.getElementById('date-day');
            const addToListBtn = document.getElementById('add-to-list-btn');
            const saveShipmentBtn = document.getElementById('save-shipment-btn');
            const addBrandBtn = document.getElementById('add-brand-btn');
            const addVendorBtn = document.getElementById('add-vendor-btn');

            // --- 1. Auto Calculation Logic ---
            function calculateTotals() {
                const quantity = parseFloat(quantityInput.value) || 0;
                const pkr = parseFloat(pkrInput.value) || 0;
                const discountPercent = parseFloat(discountPercentInput.value) || 0;
                const commission = parseFloat(commissionInput.value) || 0;

                const totalPkr = quantity * pkr;
                totalPkrInput.value = totalPkr.toFixed(2);
                const eachDiscount = pkr * (discountPercent / 100);
                eachDiscountInput.value = eachDiscount.toFixed(2);
                const afterDiscount = (pkr - eachDiscount) + commission;
                afterDiscountInput.value = afterDiscount.toFixed(2);
                const total = afterDiscount * quantity;
                totalInput.value = total.toFixed(2);
            }
            [quantityInput, pkrInput, discountPercentInput, commissionInput].forEach(input => {
                input.addEventListener('input', calculateTotals);
            });

            // --- 2. Shipment Date Logic ---
            const dayNames = ["রবিবার", "সোমবার", "মঙ্গলবার", "বুধবার", "বৃহস্পতিবার", "শুক্রবার", "শনিবার"];

            function updateDateDay() {
                if (shipmentDateInput.value) {
                    const date = new Date(shipmentDateInput.value);
                    const dayIndex = date.getUTCDay();
                    dateDaySpan.textContent = dayNames[dayIndex];
                } else {
                    dateDaySpan.textContent = '';
                }
            }
            shipmentDateInput.value = new Date().toISOString().split('T')[0];
            updateDateDay();
            shipmentDateInput.addEventListener('input', updateDateDay);

            // --- 3. "Add List" Button Logic ---
            addToListBtn.addEventListener('click', function() {
                const item = {
                    productCode: productCodeInput.value,
                    brandName: brandNameInput.value,
                    quantity: parseFloat(quantityInput.value) || 0,
                    pkr: parseFloat(pkrInput.value) || 0,
                    totalPkr: parseFloat(totalPkrInput.value) || 0,
                    weight: parseFloat(weightInput.value) || '',
                    discountPercent: parseFloat(discountPercentInput.value) || 0,
                    eachDiscount: parseFloat(eachDiscountInput.value) || 0,
                    commission: parseFloat(commissionInput.value) || 0,
                    afterDiscount: parseFloat(afterDiscountInput.value) || 0,
                    shipmentDate: shipmentDateInput.value,
                    vendorName: vendorNameSelect.value,
                    total: parseFloat(totalInput.value) || 0,
                    id: Date.now()
                };

                if (!item.productCode || item.quantity <= 0 || item.pkr <= 0) {
                    showModal("Please fill Product Code, Quantity, and PKR.", "Validation Error");
                    return;
                }

                shipmentList.push(item);
                renderShipmentList();
                clearForm();
            });

            function renderShipmentList() {
                const tbody = document.getElementById('shipment-list-body');
                tbody.innerHTML = '';
                shipmentList.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.className = 'border-b';
                    tr.innerHTML = `
                        <td class="py-2 px-3 text-sm">${item.productCode}</td>
                        <td class="py-2 px-3 text-sm">${item.brandName}</td>
                        <td class="py-2 px-3 text-sm">${item.quantity}</td>
                        <td class="py-2 px-3 text-sm">${item.pkr.toFixed(2)}</td>
                        <td class="py-2 px-3 text-sm">${item.afterDiscount.toFixed(2)}</td>
                        <td class="py-2 px-3 text-sm font-bold">${item.total.toFixed(2)}</td>
                        <td class="py-2 px-3 text-sm">${item.shipmentDate}</td>
                        <td class="py-2 px-3 text-sm">${item.vendorName}</td>
                        <td class="py-2 px-3 text-sm">
                            <button class="text-red-500 hover:text-red-700" data-id="${item.id}">Remove</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            document.getElementById('shipment-list-body').addEventListener('click', function(e) {
                if (e.target.tagName === 'BUTTON' && e.target.dataset.id) {
                    const idToRemove = parseInt(e.target.dataset.id);
                    shipmentList = shipmentList.filter(item => item.id !== idToRemove);
                    renderShipmentList();
                }
            });

            function clearForm() {
                productCodeInput.value = '';
                brandNameInput.value = '';
                quantityInput.value = '';
                pkrInput.value = '';
                weightInput.value = '';
                discountPercentInput.value = '';
                commissionInput.value = '';
                calculateTotals(); // Clear calculated fields
                document.getElementById('product-history-results').innerHTML = '';
            }

            // --- 4. API Function Logics ---

            // Product Code History Check (API Call)
            productCodeInput.addEventListener('input', function() {
                const code = productCodeInput.value.trim();
                const resultsDiv = document.getElementById('product-history-results');
                if (code.length > 3) {
                    resultsDiv.innerHTML = `<p class="text-sm text-gray-500">Checking history...</p>`;
                    fetch(`${GAS_URL}?action=getProductHistory&code=${code}`)
                        .then(res => res.json())
                        .then(data => {
                           if(data.success && data.history.length > 0) {
                              let html = '';
                              data.history.forEach(entry => {
                                 html += `<p class="text-sm text-green-700">${entry.code} - ${entry.date} - ${entry.quantity}</p>`;
                              });
                              html += `<p class="text-sm font-bold">Total: ${data.totalQty}</p>`;
                              resultsDiv.innerHTML = html;
                           } else {
                              resultsDiv.innerHTML = `<p class="text-sm text-gray-500">No previous history found.</p>`;
                           }
                        });
                } else {
                    resultsDiv.innerHTML = '';
                }
            });

            // Brand Name Search (API Call)
            brandNameInput.addEventListener('input', function() {
                const query = brandNameInput.value.trim();
                const suggestionsList = document.getElementById('brand-suggestions-list');
                
                if (query.length > 0) {
                    fetch(`${GAS_URL}?action=searchBrand&query=${query}`)
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                suggestionsList.innerHTML = '';
                                data.suggestions.forEach(brand => {
                                    const option = document.createElement('option');
                                    option.value = brand;
                                    suggestionsList.appendChild(option);
                                });
                                
                                if (!data.exactMatch) {
                                    addBrandBtn.classList.remove('hidden');
                                } else {
                                    addBrandBtn.classList.add('hidden');
                                }
                            }
                        });
                } else {
                    addBrandBtn.classList.add('hidden');
                    suggestionsList.innerHTML = '';
                }
            });

            // Add New Brand (API Call)
            addBrandBtn.addEventListener('click', function() {
                const newBrand = brandNameInput.value.trim();
                if (!newBrand) return;

                showLoading(addBrandBtn, true, 'Add');
                fetch(GAS_URL, { 
                    method: 'POST', 
                    body: JSON.stringify({ action: 'addBrand', brand: newBrand }),
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(res => res.json())
                .then(data => {
                    showLoading(addBrandBtn, false, 'Add');
                    if(data.success) {
                        showModal(`Brand '${newBrand}' added successfully!`);
                        addBrandBtn.classList.add('hidden');
                        // Optionally add to datalist
                        const option = document.createElement('option');
                        option.value = newBrand;
                        document.getElementById('brand-suggestions-list').appendChild(option);
                    } else {
                        showModal(`Error: ${data.message}`, 'Error');
                    }
                });
            });
            
            // Load Vendor List (API Call)
            function loadVendors() {
                vendorNameSelect.innerHTML = '<option value="">Loading vendors...</option>';
                fetch(`${GAS_URL}?action=getVendors`)
                .then(res => res.json())
                .then(data => {
                   vendorNameSelect.innerHTML = '<option value="">Select Vendor</option>';
                   if(data.success) {
                      data.vendors.forEach(vendor => {
                         const option = document.createElement('option');
                         option.value = vendor;
                         option.textContent = vendor;
                         vendorNameSelect.appendChild(option);
                      });
                   }
                });
            }
            // Note: loadVendors() is called after successful login

            // Add New Vendor (API Call)
            addVendorBtn.addEventListener('click', function() {
                const newVendor = prompt("Enter new vendor name:");
                if (newVendor && newVendor.trim()) {
                    showModal('Adding vendor...', 'Working');
                    fetch(GAS_URL, { 
                        method: 'POST', 
                        body: JSON.stringify({ action: 'addVendor', vendor: newVendor.trim() }),
                        headers: { 'Content-Type': 'application/json' }
                    })
                    .then(res => res.json())
                    .then(data => {
                        if(data.success) {
                            showModal(`Vendor '${newVendor}' added successfully!`);
                            loadVendors(); // Reload the vendor list
                        } else {
                            showModal(`Error: ${data.message}`, 'Error');
                        }
                    });
                }
            });

            // --- 5. "Save Shipment" Button Logic (API Call) ---
            saveShipmentBtn.addEventListener('click', function() {
                if (shipmentList.length === 0) {
                    showModal("List-e kono item add kora nei.", "Error");
                    return;
                }

                showConfirm("Are you sure you want to save this shipment to Google Sheets?", (confirmed) => {
                    if (confirmed) {
                        showLoading(saveShipmentBtn, true, 'Save Shipment');
                        fetch(GAS_URL, {
                           method: 'POST',
                           body: JSON.stringify({ action: 'saveShipment', data: shipmentList }),
                           headers: { 'Content-Type': 'application/json' }
                        })
                        .then(res => res.json())
                        .then(data => {
                           showLoading(saveShipmentBtn, false, 'Save Shipment');
                           if(data.success) {
                              showModal('Shipment successfully saved!');
                              shipmentList = [];
                              renderShipmentList();
                           } else {
                              showModal(`Error saving shipment: ${data.message}`, 'Error');
                           }
                        })
                        .catch(err => {
                            showLoading(saveShipmentBtn, false, 'Save Shipment');
                            showModal(`Network Error: ${err.message}`, 'Error');
                        });
                    }
                });
            });

        });
    </script>

</body>
</html>
