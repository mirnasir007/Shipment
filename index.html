<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shipment Management</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS for Excel Download -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- === PWA & Favicon === -->
    <!-- User requested icon -->
    <link rel="icon" type="image/png" href="logo.png">
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <!-- Theme Color -->
    <meta name="theme-color" content="#4a90e2">
    <!-- iOS support -->
    <link rel="apple-touch-icon" href="images/icon-192.png">
    <meta name="apple-mobile-web-app-status-bar" content="#4a90e2">
    <!-- === End PWA & Favicon === -->

    <style>
        /* Custom styles */
        body { font-family: 'Inter', sans-serif; }
        /* Hide elements until fully loaded */
        .hidden { display: none; }
        /* Custom alert box */
        #alert-box {
            transition: opacity 0.3s ease-in-out;
        }
        /* Custom datalist styles */
        input[list]::-webkit-calendar-picker-indicator {
            display: none;
        }
        /* Loading Spinner */
        #loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Loading Spinner Overlay -->
    <div id="loader-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div id="loader"></div>
    </div>

    <!-- Alert Box -->
    <div id="alert-box" class="fixed top-5 right-5 p-4 rounded-lg shadow-md z-50 hidden"
         onclick="this.classList.add('hidden')">
        <span id="alert-message"></span>
    </div>

    <!-- Login Page -->
    <div id="login-page" class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Shipment Login</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-1">User Name</label>
                    <input type="text" id="username" name="username" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="password" name="password" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button type="submit"
                        class="w-full bg-blue-600 text-white py-2 px-4 rounded-md shadow-lg hover:bg-blue-700 transition duration-300 font-semibold">
                    Login
                </button>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app" class="hidden">
        <!-- Header / Navbar -->
        <header class="bg-white shadow-md sticky top-0 z-10">
            <nav class="container mx-auto px-4 py-3 flex flex-wrap justify-between items-center">
                <div class="text-2xl font-bold text-blue-600">Shipment App</div>
                <div class="flex items-center space-x-2">
                    <div id="menu-items" class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                        <button data-page="add-shipment-page" class="nav-button bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Add Shipment</button>
                        <button data-page="shipment-details-page" class="nav-button bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">Shipment Details</button>
                        <button data-page="pricing-page" class="nav-button bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">Pricing</button>
                    </div>
                    <button id="logout-button" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 ml-4">Logout</button>
                </div>
            </nav>
        </header>

        <!-- Main Content Area -->
        <main class="container mx-auto p-4 mt-4">

            <!-- Page: Add Shipment -->
            <div id="add-shipment-page" class="app-page">
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">Add New Shipment</h2>
                    <form id="shipment-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        
                        <!-- Product Code -->
                        <div class="col-span-1 md:col-span-2 lg:col-span-3">
                            <label for="product-code" class="block text-sm font-medium text-gray-700">PRODUCTS CODE</label>
                            <input type="text" id="product-code" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <div id="product-history" class="text-sm text-gray-600 mt-1 p-2 bg-gray-50 rounded hidden"></div>
                        </div>

                        <!-- Brand Name -->
                        <div>
                            <label for="brand-name" class="block text-sm font-medium text-gray-700">BRAND NAME</label>
                            <div class="flex">
                                <input type="text" id="brand-name" list="brand-list" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-l-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <button type="button" id="add-brand-btn" class="mt-1 px-3 py-2 bg-green-500 text-white rounded-r-md hover:bg-green-600 hidden">+</button>
                            </div>
                            <datalist id="brand-list"></datalist>
                        </div>
                        
                        <!-- Vendor Name -->
                        <div>
                            <label for="vendor-name" class="block text-sm font-medium text-gray-700">VENDOR NAME</label>
                             <div class="flex">
                                <input type="text" id="vendor-name" list="vendor-list" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-l-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <button type="button" id="add-vendor-btn" class="mt-1 px-3 py-2 bg-green-500 text-white rounded-r-md hover:bg-green-600 hidden">+</button>
                            </div>
                            <datalist id="vendor-list"></datalist>
                        </div>

                        <!-- Shipment Date -->
                        <div>
                            <label for="shipment-date" class="block text-sm font-medium text-gray-700">SHIPMENT DATE</label>
                            <input type="date" id="shipment-date" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <span id="date-day" class="text-sm text-gray-500"></span>
                        </div>

                        <!-- Quantity -->
                        <div>
                            <label for="quantity" class="block text-sm font-medium text-gray-700">QUANTITY</label>
                            <input type="number" id="quantity" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>

                        <!-- PKR -->
                        <div>
                            <label for="pkr" class="block text-sm font-medium text-gray-700">PKR</label>
                            <input type="number" id="pkr" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>

                        <!-- TOTAL PKR (Read-only) -->
                        <div>
                            <label for="total-pkr" class="block text-sm font-medium text-gray-700">TOTAL PKR</label>
                            <input type="number" id="total-pkr" readonly class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100">
                        </div>
                        
                        <!-- Weight -->
                        <div>
                            <label for="weight" class="block text-sm font-medium text-gray-700">WEIGHT</label>
                            <input type="number" id="weight" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>

                        <!-- Discount % -->
                        <div>
                            <label for="discount-percent" class="block text-sm font-medium text-gray-700">DISCOUNT %</label>
                            <input type="number" id="discount-percent" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>

                        <!-- Each Discount Amount -->
                        <div>
                            <label for="each-discount" class="block text-sm font-medium text-gray-700">EACH DISCOUNT AMOUNT</label>
                            <input type="number" id="each-discount" readonly class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100">
                        </div>

                        <!-- Commission Amount -->
                        <div>
                            <label for="commission" class="block text-sm font-medium text-gray-700">COMMISSION AMOUNT</label>
                            <input type="number" id="commission" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>

                        <!-- AFTER DISCOUNT (Read-only) -->
                        <div>
                            <label for="after-discount" class="block text-sm font-medium text-gray-700">AFTER DISCOUNT</label>
                            <input type="number" id="after-discount" readonly class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100">
                        </div>

                        <!-- TOTAL (Read-only) -->
                        <div>
                            <label for="total" class="block text-sm font-medium text-gray-700">TOTAL</label>
                            <input type="number" id="total" readonly class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100">
                        </div>

                        <!-- Add List Button -->
                        <div class="col-span-1 md:col-span-2 lg:col-span-3">
                            <button type="button" id="add-to-list-btn" class="w-full bg-green-600 text-white py-2 px-4 rounded-md shadow-lg hover:bg-green-700 transition duration-300 font-semibold mt-4">
                                Add to List
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Added List Table -->
                <div class="bg-white p-6 rounded-lg shadow-lg mt-6">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">Shipment List</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">PRODUCTS CODE</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">BRAND NAME</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">QUANTITY</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">PKR</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">TOTAL PKR</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">WEIGHT</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DISCOUNT %</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">EACH DISCOUNT AMOUNT</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">COMMISSION AMOUNT</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">AFTER DISCOUNT</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SHIPMENT DATE</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">VENDOR NAME</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">TOTAL</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                </tr>
                            </thead>
                            <tbody id="temp-list-body" class="bg-white divide-y divide-gray-200">
                                <!-- Items will be added here by JS -->
                            </tbody>
                        </table>
                    </div>
                    <button id="save-shipment-btn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md shadow-lg hover:bg-blue-700 transition duration-300 font-semibold mt-4 hidden">
                        Save Shipment
                    </button>
                </div>
            </div>

            <!-- Page: Shipment Details -->
            <div id="shipment-details-page" class="app-page hidden">
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">Shipment Details</h2>
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                        <div class="relative w-full sm:w-1/2">
                            <input type="text" id="search-box" placeholder="Search by PRODUCTS CODE"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button id="search-btn" class="absolute right-0 top-0 h-full px-4 bg-blue-500 text-white rounded-r-md hover:bg-blue-600">Search</button>
                        </div>
                        <button id="download-details-btn" class="w-full sm:w-auto bg-green-600 text-white py-2 px-4 rounded-md shadow-lg hover:bg-green-700 transition font-semibold">
                            Download Excel
                        </button>
                    </div>
                    <!-- NEW: Div to show search total -->
                    <div id="search-total" class="text-lg font-semibold text-gray-700 mb-2 hidden"></div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr id="details-table-head">
                                    <!-- Headers will be dynamically generated -->
                                </tr>
                            </thead>
                            <tbody id="details-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Data will be loaded here by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Page: Pricing -->
            <div id="pricing-page" class="app-page hidden">
                 <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">Pricing Report</h2>
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                        <div class="w-full sm:w-1/2">
                            <label for="pricing-date" class="block text-sm font-medium text-gray-700">Select Shipment Date</label>
                            <input type="date" id="pricing-date" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <button id="load-pricing-btn" class="w-full sm:w-auto bg-blue-500 text-white py-2 px-4 rounded-md shadow-lg hover:bg-blue-600 transition font-semibold">
                            Load Data
                        </button>
                        <button id="download-pricing-btn" class="w-full sm:w-auto bg-green-600 text-white py-2 px-4 rounded-md shadow-lg hover:bg-green-700 transition font-semibold disabled:opacity-50" disabled>
                            Download Excel
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr id="pricing-table-head">
                                    <!-- Pricing headers (SL, CODE, etc.) -->
                                </tr>
                            </thead>
                            <tbody id="pricing-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Data will be loaded here by JS -->
                            </tbody>
                        </table>
                    </div>
                 </div>
            </div>
        </main>
    </div>
    
    <!-- Modal for Edit Shipment -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 hidden p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4">Edit Shipment Item</h3>
            <form id="edit-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Form fields will be dynamically injected here -->
            </form>
            <div class="mt-6 flex justify-end space-x-4">
                 <button id="cancel-edit-btn" class="bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600">Cancel</button>
                 <button id="update-shipment-btn" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">Update</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // === STATE ===
            const GAS_URL = 'https://script.google.com/macros/s/AKfycbyiC20R6jAeDfaLYjiWYEKM1uZpPo4KmV2BQiiNORAtZIy8oNYQsnDr6Ci3_FqVdXZk/exec';
            let state = {
                currentUser: null,
                brands: [],
                vendors: [],
                tempShipmentList: [],
                allShipments: [],
                pricingData: [],
                editingRowId: null,
            };

            // === DOM ELEMENTS ===
            const loginPage = document.getElementById('login-page');
            const appPage = document.getElementById('app');
            const loginForm = document.getElementById('login-form');
            const loader = document.getElementById('loader-overlay');
            const alertBox = document.getElementById('alert-box');
            const alertMessage = document.getElementById('alert-message');
            const navButtons = document.querySelectorAll('.nav-button');
            const appPages = document.querySelectorAll('.app-page');
            const logoutButton = document.getElementById('logout-button');
            const menuItems = document.getElementById('menu-items');

            // Add Shipment Page
            const shipmentForm = document.getElementById('shipment-form');
            const productCodeInput = document.getElementById('product-code');
            const productHistoryDiv = document.getElementById('product-history');
            const brandNameInput = document.getElementById('brand-name');
            const addBrandBtn = document.getElementById('add-brand-btn');
            const brandListDatalist = document.getElementById('brand-list');
            const vendorNameInput = document.getElementById('vendor-name');
            const addVendorBtn = document.getElementById('add-vendor-btn');
            const vendorListDatalist = document.getElementById('vendor-list');
            const shipmentDateInput = document.getElementById('shipment-date');
            const dateDaySpan = document.getElementById('date-day');
            const quantityInput = document.getElementById('quantity');
            const pkrInput = document.getElementById('pkr');
            const totalPkrInput = document.getElementById('total-pkr');
            const weightInput = document.getElementById('weight');
            const discountPercentInput = document.getElementById('discount-percent');
            const eachDiscountInput = document.getElementById('each-discount');
            const commissionInput = document.getElementById('commission');
            const afterDiscountInput = document.getElementById('after-discount');
            const totalInput = document.getElementById('total');
            const addToListBtn = document.getElementById('add-to-list-btn');
            const tempListBody = document.getElementById('temp-list-body');
            const saveShipmentBtn = document.getElementById('save-shipment-btn');

            // Shipment Details Page
            const detailsPage = document.getElementById('shipment-details-page');
            const searchBox = document.getElementById('search-box');
            const searchBtn = document.getElementById('search-btn');
            const downloadDetailsBtn = document.getElementById('download-details-btn');
            const detailsTableHead = document.getElementById('details-table-head');
            const detailsTableBody = document.getElementById('details-table-body');
            const editModal = document.getElementById('edit-modal');
            const editForm = document.getElementById('edit-form');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            const updateShipmentBtn = document.getElementById('update-shipment-btn');

            // Pricing Page
            const pricingPage = document.getElementById('pricing-page');
            const pricingDateInput = document.getElementById('pricing-date');
            const loadPricingBtn = document.getElementById('load-pricing-btn');
            const downloadPricingBtn = document.getElementById('download-pricing-btn');
            const pricingTableHead = document.getElementById('pricing-table-head');
            const pricingTableBody = document.getElementById('pricing-table-body');
            
            const shipmentHeaders = ['PRODUCTS CODE', 'BRAND NAME', 'QUANTITY', 'PKR', 'TOTAL PKR', 'WEIGHT', 'DISCOUNT %', 'EACH DISCOUNT AMOUNT', 'COMMISSION AMOUNT', 'AFTER DISCOUNT', 'SHIPMENT DATE', 'VENDOR NAME', 'TOTAL'];
            const pricingHeaders = ['SL', 'CODE', 'QUANTITY', 'WEIGHT', 'PKR', 'BD', 'BUY', 'SELLING', 'PREVIOSE SELLING', 'ORGINAL RATE', 'BRAND NAME'];

            // === HELPER FUNCTIONS ===

            // *** NEW: Helper to format date with weekday ***
            function formatDateWithDay(dateString) {
                if (!dateString) return '';
                const date = new Date(dateString);
                // Options for a readable format with weekday
                const options = { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' };
                return date.toLocaleDateString('en-US', options);
            }

            // Show/Hide Loader
            function showLoader(show = true) {
                loader.classList.toggle('hidden', !show);
            }

            // Show Alert
            function showAlert(message, isError = false) {
                alertMessage.textContent = message;
                alertBox.classList.remove('hidden', 'bg-green-500', 'bg-red-500', 'text-white');
                if (isError) {
                    alertBox.classList.add('bg-red-500', 'text-white');
                } else {
                    alertBox.classList.add('bg-green-500', 'text-white');
                }
                setTimeout(() => {
                    alertBox.classList.add('hidden');
                }, 3000);
            }

            // API Call Function
            async function apiCall(action, payload = {}) {
                showLoader();
                try {
                    const response = await fetch(GAS_URL, {
                        method: 'POST',
                        redirect: 'follow',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8', }, // Corrected charset
                        body: JSON.stringify({
                            action,
                            auth: state.currentUser, // Send auth details with every request
                            ...payload
                        })
                    });
                    const result = await response.json();
                    showLoader(false);
                    if (result.status === 'error') {
                        showAlert(result.message, true);
                        return null;
                    }
                    return result;
                } catch (error) {
                    showLoader(false);
                    showAlert('Network or API error: ' + error.message, true);
                    return null;
                }
            }

            // Page Navigation
            function showPage(pageId) {
                appPages.forEach(page => page.classList.add('hidden'));
                document.getElementById(pageId).classList.remove('hidden');

                navButtons.forEach(button => {
                    if (button.dataset.page === pageId) {
                        button.classList.remove('bg-gray-200', 'text-gray-700');
                        button.classList.add('bg-blue-500', 'text-white');
                    } else {
                        button.classList.add('bg-gray-200', 'text-gray-700');
                        button.classList.remove('bg-blue-500', 'text-white');
                    }
                });
                
                // Load data for page if needed
                if (pageId === 'shipment-details-page') {
                    loadShipmentDetails();
                }
            }
            
            // Apply User Permissions
            function applyPermissions() {
                if (!state.currentUser || !state.currentUser.access || state.currentUser.access.toLowerCase() !== 'admin') {
                    // Hide admin-only menu items
                    menuItems.querySelector('[data-page="add-shipment-page"]').classList.add('hidden');
                    menuItems.querySelector('[data-page="pricing-page"]').classList.add('hidden');
                    
                    // Hide admin-only buttons in UI
                    addBrandBtn.classList.add('hidden');
                    addVendorBtn.classList.add('hidden');
                    addToListBtn.classList.add('hidden');
                    saveShipmentBtn.classList.add('hidden');
                    downloadDetailsBtn.classList.add('hidden');
                    
                    // Show Shipment Details by default for non-admin
                    showPage('shipment-details-page');
                } else {
                    // Show all elements for admin
                    menuItems.querySelector('[data-page="add-shipment-page"]').classList.remove('hidden');
                    menuItems.querySelector('[data-page="pricing-page"]').classList.remove('hidden');
                    showPage('add-shipment-page');
                }
            }

            // === LOGIN / LOGOUT ===
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const userName = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                const result = await apiCall('login', { userName, password });
                
                if (result && result.status === 'success') {
                    state.currentUser = { userName: result.userName, access: result.access };
                    // *** NEW: Save user to localStorage ***
                    localStorage.setItem('currentUser', JSON.stringify(state.currentUser)); 
                    
                    loginPage.classList.add('hidden');
                    appPage.classList.remove('hidden');
                    showAlert('Login successful!');
                    loadInitialData();
                    applyPermissions();
                }
            });

            logoutButton.addEventListener('click', () => {
                state.currentUser = null;
                // *** NEW: Remove user from localStorage ***
                localStorage.removeItem('currentUser'); 
                
                state.tempShipmentList = [];
                state.allShipments = [];
                state.brands = [];
                state.vendors = [];
                appPage.classList.add('hidden');
                loginPage.classList.remove('hidden');
            });
            
            // === INITIAL DATA LOAD ===
            async function loadInitialData() {
                const result = await apiCall('getInitialData');
                if (result) {
                    state.brands = result.brands;
                    state.vendors = result.vendors;
                    populateDatalists();
                }
            }
            
            function populateDatalists() {
                brandListDatalist.innerHTML = '';
                state.brands.forEach(brand => {
                    const option = document.createElement('option');
                    option.value = brand;
                    brandListDatalist.appendChild(option);
                });
                
                vendorListDatalist.innerHTML = '';
                state.vendors.forEach(vendor => {
                    const option = document.createElement('option');
                    option.value = vendor;
                    vendorListDatalist.appendChild(option);
                });
            }

            // === PWA Registration ===
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('sw.js')
                        .then(registration => console.log('ServiceWorker registration successful'))
                        .catch(err => console.log('ServiceWorker registration failed: ', err));
                });
            }

            // *** NEW: Check for saved user on page load ***
            (function checkSavedLogin() {
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    try {
                        state.currentUser = JSON.parse(savedUser);
                        if (state.currentUser && state.currentUser.userName) {
                            loginPage.classList.add('hidden');
                            appPage.classList.remove('hidden');
                            loadInitialData();
                            applyPermissions();
                            showAlert(`Welcome back, ${state.currentUser.userName}!`);
                        }
                    } catch (e) {
                        console.error('Failed to parse saved user', e);
                        localStorage.removeItem('currentUser');
                    }
                }
            })();
            
            // === PAGE NAVIGATION ===
            navButtons.forEach(button => {
                button.addEventListener('click', () => showPage(button.dataset.page));
            });

            // === ADD SHIPMENT PAGE ===
            
            // Set current date
            const today = new Date().toISOString().split('T')[0];
            shipmentDateInput.value = today;
            updateDateDay(today);

            shipmentDateInput.addEventListener('change', (e) => updateDateDay(e.target.value));

            function updateDateDay(dateString) {
                if (!dateString) {
                    dateDaySpan.textContent = '';
                    return;
                }
                const date = new Date(dateString);
                // Adding time offset to prevent off-by-one day errors
                const utcDate = new Date(date.getTime() + date.getTimezoneOffset() * 60000);
                dateDaySpan.textContent = utcDate.toLocaleDateString('en-US', { weekday: 'long' });
            }

            // Calculations
            function updateCalculations() {
                const qty = parseFloat(quantityInput.value) || 0;
                const pkr = parseFloat(pkrInput.value) || 0;
                const eachDiscount = parseFloat(eachDiscountInput.value) || 0;
                const commission = parseFloat(commissionInput.value) || 0;
                
                const totalPkr = qty * pkr;
                const afterDiscount = pkr - eachDiscount + commission;
                const total = afterDiscount * qty;
                
                totalPkrInput.value = totalPkr.toFixed(0);
                afterDiscountInput.value = afterDiscount.toFixed(0);
                totalInput.value = total.toFixed(0);
            }

            function calculateEachDiscount() {
                const pkr = parseFloat(pkrInput.value) || 0;
                const discountPercent = parseFloat(discountPercentInput.value) || 0;
                const eachDiscount = pkr * (discountPercent / 100);
                eachDiscountInput.value = eachDiscount.toFixed(0);
                // Trigger other calculations that depend on this
                updateCalculations();
            }
            
            [quantityInput, pkrInput, commissionInput].forEach(input => {
                input.addEventListener('input', updateCalculations);
            });
            
            [pkrInput, discountPercentInput].forEach(input => {
                input.addEventListener('input', calculateEachDiscount);
            });

            // Product Code Check (Debounced)
            let debounceTimer;
            productCodeInput.addEventListener('change', async () => { // Changed from 'input' to 'change'
                // clearTimeout(debounceTimer);
                // debounceTimer = setTimeout(async () => {
                    const code = productCodeInput.value;
                    if (code.length < 3) {
                        productHistoryDiv.classList.add('hidden');
                        return;
                    }
                    const result = await apiCall('checkProductCode', { code });
                    if (result && result.totalQty > 0) {
                        let historyHtml = `<strong>Previous Entries (${result.totalQty} Total):</strong><br>`;
                        result.history.forEach(item => {
                            const date = new Date(item.date).toLocaleDateString('en-US', { day: 'numeric', month: 'short', weekday: 'long' }); // Changed 'short' to 'long'
                            historyHtml += `<span>${date}: ${item.qty} pcs</span><br>`;
                        });
                        productHistoryDiv.innerHTML = historyHtml;
                        productHistoryDiv.classList.remove('hidden');
                    } else {
                        productHistoryDiv.textContent = 'No previous entries found.';
                        productHistoryDiv.classList.remove('hidden');
                    }
                // }, 500);
            });

            // Brand/Vendor Add Buttons
            brandNameInput.addEventListener('input', () => {
                const val = brandNameInput.value;
                addBrandBtn.classList.toggle('hidden', !val || state.brands.includes(val));
            });
            
            vendorNameInput.addEventListener('input', () => {
                const val = vendorNameInput.value;
                addVendorBtn.classList.toggle('hidden', !val || state.vendors.includes(val));
            });

            addBrandBtn.addEventListener('click', async () => {
                const brandName = brandNameInput.value;
                const result = await apiCall('addBrand', { brandName });
                if (result) {
                    state.brands.push(result.brandName);
                    populateDatalists();
                    addBrandBtn.classList.add('hidden');
                    showAlert(`Brand '${brandName}' added.`);
                }
            });

            // *** NEW: Function to reset only specific fields ***
            function resetAddShipmentForm() {
                productCodeInput.value = '';
                quantityInput.value = '';
                pkrInput.value = '';
                totalPkrInput.value = '';
                weightInput.value = '';
                discountPercentInput.value = '';
                eachDiscountInput.value = '';
                commissionInput.value = '';
                afterDiscountInput.value = '';
                totalInput.value = '';
                productHistoryDiv.classList.add('hidden');
            }

            // Add to List
            addToListBtn.addEventListener('click', () => {
                const item = {
                    productCode: productCodeInput.value,
                    brandName: brandNameInput.value,
                    quantity: parseFloat(quantityInput.value) || 0,
                    pkr: parseFloat(pkrInput.value) || 0,
                    totalPkr: parseFloat(totalPkrInput.value) || 0,
                    // *** UPDATED: Convert weight from g to kg ***
                    weight: (parseFloat(weightInput.value) || 0) / 1000, 
                    discountPercent: parseFloat(discountPercentInput.value) || 0,
                    eachDiscountAmount: parseFloat(eachDiscountInput.value) || 0,
                    commissionAmount: parseFloat(commissionInput.value) || 0,
                    afterDiscount: parseFloat(afterDiscountInput.value) || 0,
                    shipmentDate: shipmentDateInput.value,
                    vendorName: vendorNameInput.value,
                    total: parseFloat(totalInput.value) || 0,
                    id: Date.now() // Unique ID for temp list
                };
                
                // Simple validation
                if (!item.productCode || !item.brandName || !item.quantity || !item.shipmentDate || !item.vendorName) {
                    showAlert('Please fill all required fields (Code, Brand, Qty, Date, Vendor).', true);
                    return;
                }
                
                state.tempShipmentList.push(item);
                renderTempList();
                
                // *** UPDATED: Call partial reset function ***
                resetAddShipmentForm(); 
                
                // *** REMOVED: These lines are no longer needed, as we want to remember the date ***
                // shipmentForm.reset(); 
                // shipmentDateInput.value = today; 
                // updateDateDay(today);
                // productHistoryDiv.classList.add('hidden');
            });
            
            function renderTempList() {
                tempListBody.innerHTML = '';
                if (state.tempShipmentList.length === 0) {
                    saveShipmentBtn.classList.add('hidden');
                    return;
                }
                
                state.tempShipmentList.forEach((item, index) => {
                    const row = `
                        <tr data-id="${item.id}">
                            <td class="px-3 py-2 whitespace-nowrap text-sm">${item.productCode}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm">${item.brandName}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm">${item.quantity}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm">${item.pkr.toFixed(0)}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm">${item.totalPkr.toFixed(0)}</td>
                            <!-- *** UPDATED: Show weight as decimal *** -->
                            <td class="px-3 py-2 whitespace-nowrap text-sm">${item.weight.toFixed(3)}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm">${item.discountPercent}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm">${item.eachDiscountAmount.toFixed(0)}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm">${item.commissionAmount.toFixed(0)}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm">${item.afterDiscount.toFixed(0)}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm">${item.shipmentDate}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm">${item.vendorName}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm">${item.total.toFixed(0)}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm">
                                <button class="remove-item-btn text-red-500 hover:text-red-700" data-id="${item.id}">Remove</button>
                            </td>
                        </tr>
                    `;
                    tempListBody.innerHTML += row;
                });
                
                // Add event listeners to new remove buttons
                document.querySelectorAll('.remove-item-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = parseInt(e.target.dataset.id);
                        state.tempShipmentList = state.tempShipmentList.filter(item => item.id !== id);
                        renderTempList();
                    });
                });
                
                saveShipmentBtn.classList.remove('hidden');
            }
            
            // Save Shipment
            saveShipmentBtn.addEventListener('click', async () => {
                const result = await apiCall('saveShipment', { items: state.tempShipmentList });
                if (result) {
                    showAlert(`Successfully saved ${result.saved} items.`);
                    state.tempShipmentList = [];
                    renderTempList();
                }
            });

            // === SHIPMENT DETAILS PAGE ===
            
            async function loadShipmentDetails() {
                const result = await apiCall('getShipmentDetails');
                if (result) {
                    state.allShipments = result.data;
                    renderDetailsTable(state.allShipments);
                }
            }
            
            function renderDetailsTable(data) {
                if (data.length === 0) {
                    detailsTableHead.innerHTML = '';
                    detailsTableBody.innerHTML = '<tr><td colspan="100%" class="text-center p-4">No data found.</td></tr>';
                    return;
                }
                
                // Create headers
                const headers = Object.keys(data[0]).filter(h => h !== 'rowId');
                let headHtml = '';
                headers.forEach(h => {
                    headHtml += `<th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${h}</th>`;
                });
                if (state.currentUser.access === 'admin') {
                    headHtml += `<th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>`;
                }
                detailsTableHead.innerHTML = `<tr>${headHtml}</tr>`;
                
                // Create body
                let bodyHtml = '';
                data.forEach(item => {
                    bodyHtml += `<tr data-row-id="${item.rowId}">`;
                    headers.forEach(header => {
                        let value = item[header];
                        // *** UPDATED: Format date with weekday ***
                        if (header === 'SHIPMENT DATE' && value) {
                            value = formatDateWithDay(value); // Use new helper
                        }
                        // *** NEW: Format weight in details table ***
                        if (header === 'WEIGHT' && value) {
                            value = (parseFloat(value) || 0).toFixed(3);
                        }
                        bodyHtml += `<td class="px-3 py-2 whitespace-nowrap text-sm">${value}</td>`;
                    });
                    if (state.currentUser.access.toLowerCase() === 'admin') {
                        bodyHtml += `<td class="px-3 py-2 whitespace-nowrap text-sm">
                                       <button class="edit-btn text-blue-500 hover:text-blue-700" data-row-id="${item.rowId}">Edit</button>
                                   </td>`;
                    }
                    bodyHtml += `</tr>`;
                });
                detailsTableBody.innerHTML = bodyHtml;
                
                // Add edit button listeners
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => openEditModal(e.target.dataset.rowId));
                });
            }

            // Search button
            const searchTotalDiv = document.getElementById('search-total'); // Get the new div
            searchBtn.addEventListener('click', async () => {
                const code = searchBox.value;
                searchTotalDiv.classList.add('hidden'); // Hide on new search
                
                if (!code) {
                    renderDetailsTable(state.allShipments); // Show all
                    return;
                }
                const result = await apiCall('searchShipments', { code });
                if (result) {
                    renderDetailsTable(result.data);
                    
                    // *** NEW: Calculate and show total quantity ***
                    if (result.data.length > 0) {
                        const totalQty = result.data.reduce((sum, item) => sum + (parseFloat(item['QUANTITY']) || 0), 0);
                        searchTotalDiv.textContent = `Product Code: ${code} - Total Quantity: ${totalQty}`;
                        searchTotalDiv.classList.remove('hidden');
                    }
                }
            });

            // *** NEW: Add listener for Enter key on search box ***
            searchBox.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchBtn.click(); // Programmatically click the search button
                }
            });
            
            downloadDetailsBtn.addEventListener('click', () => {
                // *** UPDATED: Format date for Excel download ***
                const dataToDownload = state.allShipments.map(item => {
                    const formattedItem = { ...item }; // Create a copy
                    // Format the date specifically for the download
                    if (formattedItem['SHIPMENT DATE']) {
                        formattedItem['SHIPMENT DATE'] = formatDateWithDay(formattedItem['SHIPMENT DATE']);
                    }
                    delete formattedItem.rowId; // Remove rowId for download
                    return formattedItem;
                });

                const ws = XLSX.utils.json_to_sheet(dataToDownload);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Shipment Details');
                XLSX.writeFile(wb, 'Shipment_Details.xlsx');
            });

            // === EDIT MODAL ===
            function openEditModal(rowId) {
                const item = state.allShipments.find(s => s.rowId == rowId);
                if (!item) return;
                
                state.editingRowId = rowId;
                editForm.innerHTML = ''; // Clear previous form
                
                // Map sheet headers to item keys
                const itemKeys = {
                    'PRODUCTS CODE': 'productCode',
                    'BRAND NAME': 'brandName',
                    'QUANTITY': 'quantity',
                    'PKR': 'pkr',
                    'TOTAL PKR': 'totalPkr',
                    'WEIGHT': 'weight',
                    'DISCOUNT %': 'discountPercent',
                    'EACH DISCOUNT AMOUNT': 'eachDiscountAmount',
                    'COMMISSION AMOUNT': 'commissionAmount',
                    'AFTER DISCOUNT': 'afterDiscount',
                    'SHIPMENT DATE': 'shipmentDate',
                    'VENDOR NAME': 'vendorName',
                    'TOTAL': 'total',
                };

                shipmentHeaders.forEach(header => {
                    const key = itemKeys[header];
                    let value = item[header];
                    let inputType = 'text';
                    let isReadOnly = false;
                    let listName = '';
                    
                    // *** NEW: Check for readonly fields ***
                    if (['TOTAL PKR', 'EACH DISCOUNT AMOUNT', 'AFTER DISCOUNT', 'TOTAL'].includes(header)) {
                        isReadOnly = true;
                    }

                    // *** NEW: Check for datalist fields ***
                    if (header === 'BRAND NAME') listName = 'brand-list';
                    if (header === 'VENDOR NAME') listName = 'vendor-list';
                    
                    if (typeof value === 'number') {
                        inputType = 'number';
                    }
                    if (header === 'SHIPMENT DATE' && value) {
                        inputType = 'date';
                        value = new Date(value).toLocaleDateString('en-CA'); // yyyy-mm-dd format
                    }
                    // *** NEW: Convert weight back to grams for editing ***
                    if (header === 'WEIGHT' && value) {
                        value = (parseFloat(value) || 0) * 1000;
                    }
                    
                    editForm.innerHTML += `
                        <div>
                            <label for="edit-${key}" class="block text-sm font-medium text-gray-700">${header}</label>
                            <input type="${inputType}" id="edit-${key}" data-key="${key}" data-header="${header}" value="${value}"
                                   ${listName ? `list="${listName}"` : ''}
                                   ${isReadOnly ? 'readonly' : ''}
                                   class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 ${isReadOnly ? 'bg-gray-100' : ''}">
                        </div>
                    `;
                });
                
                // *** NEW: Add calculation logic to edit modal inputs ***
                const editQty = document.getElementById('edit-quantity');
                const editPkr = document.getElementById('edit-pkr');
                const editTotalPkr = document.getElementById('edit-totalPkr');
                const editDiscountPercent = document.getElementById('edit-discountPercent');
                const editEachDiscount = document.getElementById('edit-eachDiscountAmount');
                // *** FIXED: Corrected the ID from 'edit-commission' to 'edit-commissionAmount' ***
                const editCommission = document.getElementById('edit-commissionAmount'); 
                const editAfterDiscount = document.getElementById('edit-afterDiscount');
                const editTotal = document.getElementById('edit-total');

                function calculateEditEachDiscount() {
                    const pkr = parseFloat(editPkr.value) || 0;
                    const discountPercent = parseFloat(editDiscountPercent.value) || 0;
                    const eachDiscount = pkr * (discountPercent / 100);
                    editEachDiscount.value = eachDiscount.toFixed(0);
                    updateEditCalculations(); // Trigger main calculation
                }

                function updateEditCalculations() {
                    const qty = parseFloat(editQty.value) || 0;
                    const pkr = parseFloat(editPkr.value) || 0;
                    const eachDiscount = parseFloat(editEachDiscount.value) || 0;
                    const commission = parseFloat(editCommission.value) || 0;
                    
                    const totalPkr = qty * pkr;
                    const afterDiscount = pkr - eachDiscount + commission;
                    const total = afterDiscount * qty;
                    
                    editTotalPkr.value = totalPkr.toFixed(0);
                    editAfterDiscount.value = afterDiscount.toFixed(0);
                    editTotal.value = total.toFixed(0);
                }

                // Attach listeners
                [editQty, editPkr, editCommission].forEach(input => {
                    if(input) input.addEventListener('input', updateEditCalculations);
                });
                
                [editPkr, editDiscountPercent].forEach(input => {
                    if(input) input.addEventListener('input', calculateEditEachDiscount);
                });

                editModal.classList.remove('hidden');
            }
            
            cancelEditBtn.addEventListener('click', () => {
                editModal.classList.add('hidden');
                state.editingRowId = null;
            });
            
            updateShipmentBtn.addEventListener('click', async () => {
                const updatedItem = {};
                editForm.querySelectorAll('input').forEach(input => {
                    const key = input.dataset.key;
                    const header = input.dataset.header;
                    let value = input.value;
                    if (input.type === 'number') value = parseFloat(value) || 0;
                    if (input.type === 'date') value = new Date(input.value).toISOString(); // Store as ISO string
                    
                    // *** NEW: Convert weight back to kg on update ***
                    if (header === 'WEIGHT') {
                        value = (parseFloat(input.value) || 0) / 1000;
                    }

                    updatedItem[key] = value;
                });
                
                const result = await apiCall('updateShipment', { rowId: state.editingRowId, data: updatedItem });
                
                if (result) {
                    showAlert('Shipment updated successfully.');
                    editModal.classList.add('hidden');
                    loadShipmentDetails(); // Refresh data
                }
            });

            // === PRICING PAGE ===
            loadPricingBtn.addEventListener('click', async () => {
                const date = pricingDateInput.value;
                if (!date) {
                    showAlert('Please select a date.', true);
                    return;
                }
                
                const result = await apiCall('getPricingData', { date });
                
                if (result && result.data.length > 0) {
                    state.pricingData = result.data;
                    renderPricingTable(result.data);
                    downloadPricingBtn.disabled = false;
                } else {
                    state.pricingData = [];
                    pricingTableHead.innerHTML = '';
                    pricingTableBody.innerHTML = '<tr><td colspan="100%" class="text-center p-4">No data found for this date.</td></tr>';
                    downloadPricingBtn.disabled = true;
                }
            });
            
            function renderPricingTable(data) {
                // Headers
                pricingTableHead.innerHTML = `<tr>${pricingHeaders.map(h => `<th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${h}</th>`).join('')}</tr>`;
                
                // Body
                let bodyHtml = '';
                data.forEach((item, index) => {
                    bodyHtml += '<tr>';
                    bodyHtml += `<td class="px-3 py-2 whitespace-nowrap text-sm">${index + 1}</td>`; // SL
                    bodyHtml += `<td class="px-3 py-2 whitespace-nowrap text-sm">${item['PRODUCTS CODE']}</td>`; // CODE
                    bodyHtml += `<td class="px-3 py-2 whitespace-nowrap text-sm">${item['QUANTITY']}</td>`; // QUANTITY
                    // *** UPDATED: Format weight in pricing table ***
                    bodyHtml += `<td class="px-3 py-2 whitespace-nowrap text-sm">${(parseFloat(item['WEIGHT']) || 0).toFixed(3)}</td>`; // WEIGHT
                    bodyHtml += `<td class="px-3 py-2 whitespace-nowrap text-sm">${item['AFTER DISCOUNT']}</td>`; // PKR (from AFTER DISCOUNT)
                    bodyHtml += `<td class="px-3 py-2 whitespace-nowrap text-sm"></td>`; // BD (empty)
                    bodyHtml += `<td class="px-3 py-2 whitespace-nowrap text-sm"></td>`; // BUY (empty)
                    bodyHtml += `<td class="px-3 py-2 whitespace-nowrap text-sm"></td>`; // SELLING (empty)
                    bodyHtml += `<td class="px-3 py-2 whitespace-nowrap text-sm"></td>`; // PREVIOSE SELLING (empty)
                    bodyHtml += `<td class="px-3 py-2 whitespace-nowrap text-sm">${item['PKR']}</td>`; // ORGINAL RATE (from PKR)
                    bodyHtml += `<td class="px-3 py-2 whitespace-nowrap text-sm">${item['BRAND NAME']}</td>`; // BRAND NAME
                    bodyHtml += '</tr>';
                });
                pricingTableBody.innerHTML = bodyHtml;
            }

            downloadPricingBtn.addEventListener('click', () => {
                const dataToDownload = state.pricingData.map((item, index) => ({
                    'SL': index + 1,
                    'CODE': item['PRODUCTS CODE'],
                    'QUANTITY': item['QUANTITY'],
                    'WEIGHT': item['WEIGHT'],
                    'PKR': item['AFTER DISCOUNT'],
                    'BD': '',
                    'BUY': '',
                    'SELLING': '',
                    'PREVIOSE SELLING': '',
                    'ORGINAL RATE': item['PKR'],
                    'BRAND NAME': item['BRAND NAME']
                }));
                
                const ws = XLSX.utils.json_to_sheet(dataToDownload, { header: pricingHeaders });
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Pricing Report');
                XLSX.writeFile(wb, `Pricing_Report_${pricingDateInput.value}.xlsx`);
            });

        });
    </script>
</body>
</html>
